<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ¦ˆ SHARK Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .skeleton {
            background: linear-gradient(90deg, #1f2937 25%, #374151 50%, #1f2937 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .pulse-open {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        body {
            background-color: #030712;
        }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">
    <!-- API Key Modal -->
    <div id="keyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 border border-gray-700 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold mb-4">Enter API Key</h3>
            <input type="text" id="keyInput" placeholder="API Key" 
                class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-white mb-4">
            <button id="keySubmit" class="w-full bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-semibold">
                Connect
            </button>
        </div>
    </div>

    <!-- Status Bar -->
    <div id="statusBar" class="sticky top-0 z-40 bg-gray-900/95 backdrop-blur border-b border-gray-800 px-6 py-3">
        <div class="flex flex-wrap gap-x-6 gap-y-1 items-center text-sm">
            <div class="flex items-center gap-2 font-bold text-lg">
                ðŸ¦ˆ <span>SHARK</span>
                <span id="statusDot" class="w-2 h-2 rounded-full bg-gray-500"></span>
            </div>
            <div id="statusBadge" class="px-2 py-0.5 rounded border text-xs font-semibold bg-gray-500/20 text-gray-400 border-gray-500/30">
                CONNECTING
            </div>
            <div class="flex items-center gap-1.5">
                <span class="text-gray-500 text-xs">Uptime</span>
                <span id="uptime" class="font-mono font-semibold text-white">â€”</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="text-gray-500 text-xs">msg/s</span>
                <span id="msgPerSec" class="font-mono font-semibold text-white">â€”</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="text-gray-500 text-xs">Signals</span>
                <span id="signals" class="font-mono font-semibold text-white">â€”</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="text-gray-500 text-xs">Open</span>
                <span id="openPositions" class="font-mono font-semibold text-white">â€”</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="text-gray-500 text-xs">Today P&L</span>
                <span id="dailyPnl" class="font-mono font-semibold">â€”</span>
            </div>
            <div class="flex items-center gap-1.5">
                <span class="text-gray-500 text-xs">Total P&L</span>
                <span id="totalPnl" class="font-mono font-semibold">â€”</span>
            </div>
            <div id="cooldownBadge" class="px-2 py-0.5 rounded border text-xs font-semibold bg-red-500/20 text-red-400 border-red-500/30 hidden">
                COOLDOWN
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-[1600px] mx-auto px-4 py-6 space-y-6">
        <!-- Key Metrics Panel -->
        <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
            <div class="flex items-center justify-between px-5 py-3 border-b border-gray-800">
                <h2 class="font-semibold text-sm text-gray-200">Key Metrics</h2>
            </div>
            <div class="p-5">
                <div id="metricsGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
                    <!-- Metrics will be populated here -->
                </div>
            </div>
        </div>

        <!-- Trade Feed -->
        <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
            <div class="flex items-center justify-between px-5 py-3 border-b border-gray-800">
                <h2 class="font-semibold text-sm text-gray-200">Trade Feed</h2>
                <div class="flex gap-2 text-xs">
                    <button id="filterAll" class="px-2 py-1 rounded bg-gray-700 text-white">ALL</button>
                    <button id="filterOpen" class="px-2 py-1 rounded text-gray-400 hover:text-white">OPEN</button>
                    <button id="filterClosed" class="px-2 py-1 rounded text-gray-400 hover:text-white">CLOSED</button>
                    <span class="text-gray-600 mx-1">|</span>
                    <button id="dirAll" class="px-2 py-1 rounded bg-gray-700 text-white">ALL</button>
                    <button id="dirUp" class="px-2 py-1 rounded text-gray-400 hover:text-white">UP</button>
                    <button id="dirDown" class="px-2 py-1 rounded text-gray-400 hover:text-white">DOWN</button>
                </div>
            </div>
            <div class="p-0">
                <!-- Table Header -->
                <div class="grid grid-cols-[60px_80px_1fr_60px_70px_70px_80px_70px_70px_90px] gap-2 px-3 py-2 text-xs text-gray-500 border-b border-gray-700 font-semibold">
                    <span>ID</span><span>Time</span><span>Market</span><span>Dir</span>
                    <span>Entry</span><span>Exit</span><span>P&L</span><span>Status</span>
                    <span>Hold</span><span>Reason</span>
                </div>
                <div id="tradesContainer" class="max-h-[400px] overflow-y-auto">
                    <div class="text-center text-gray-500 py-8">Collecting data...</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- P&L Chart -->
            <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
                <div class="px-5 py-3 border-b border-gray-800">
                    <h2 class="font-semibold text-sm text-gray-200">Cumulative P&L</h2>
                </div>
                <div class="p-4">
                    <div class="chart-container">
                        <canvas id="pnlChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Win Rate Chart -->
            <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
                <div class="px-5 py-3 border-b border-gray-800">
                    <h2 class="font-semibold text-sm text-gray-200">Rolling Win Rate (50)</h2>
                </div>
                <div class="p-4">
                    <div class="chart-container">
                        <canvas id="winRateChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- P&L Histogram -->
            <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
                <div class="px-5 py-3 border-b border-gray-800">
                    <h2 class="font-semibold text-sm text-gray-200">P&L Distribution</h2>
                </div>
                <div class="p-4">
                    <div class="chart-container">
                        <canvas id="histogramChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signal Monitor -->
        <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
            <div class="flex items-center justify-between px-5 py-3 border-b border-gray-800">
                <h2 class="font-semibold text-sm text-gray-200">Signal Monitor</h2>
                <div class="flex gap-2 text-xs">
                    <button id="sigFilterAll" class="px-2 py-1 rounded bg-gray-700 text-white">ALL</button>
                    <button id="sigFilterLarge" class="px-2 py-1 rounded text-gray-400 hover:text-white">â‰¥5Â¢</button>
                    <button id="sigFilterSmall" class="px-2 py-1 rounded text-gray-400 hover:text-white">&lt;5Â¢</button>
                </div>
            </div>
            <div class="p-0">
                <!-- Signal Header -->
                <div class="grid grid-cols-[100px_80px_1fr_50px_70px_60px] gap-2 px-3 py-2 text-xs text-gray-500 border-b border-gray-700 font-semibold">
                    <span>Time</span><span>Token</span><span>Market</span><span>Dir</span><span>Change</span><span>Price</span>
                </div>
                <div id="signalsContainer" class="max-h-[300px] overflow-y-auto">
                    <div class="text-center text-gray-500 py-8">Collecting signals...</div>
                </div>
            </div>
        </div>

        <!-- Strategy Breakdown -->
        <div class="bg-gray-900 border border-gray-800 rounded-xl overflow-hidden">
            <div class="px-5 py-3 border-b border-gray-800">
                <h2 class="font-semibold text-sm text-gray-200">Strategy Breakdown</h2>
            </div>
            <div class="p-5">
                <div id="strategiesContainer" class="text-center text-gray-500 py-8">
                    Collecting strategy data...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let apiKey = '';
        let currentFilter = 'all';
        let currentDirFilter = 'all';
        let currentSigFilter = 'all';
        let allTrades = [];
        let allSignals = [];
        let expandedTrade = null;
        let charts = {};

        // API base URL
        const API_BASE = 'https://api.peytoncampbell.ca';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initApiKey();
            setupEventListeners();
            if (apiKey) {
                startDataFetching();
            }
        });

        // API Key Management
        function initApiKey() {
            // Check URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const urlKey = urlParams.get('key');
            
            if (urlKey) {
                apiKey = urlKey;
                localStorage.setItem('dashboardApiKey', apiKey);
                // Remove key from URL for security
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                // Check localStorage
                apiKey = localStorage.getItem('dashboardApiKey') || '';
            }
            
            if (!apiKey) {
                showKeyModal();
            }
        }

        function showKeyModal() {
            document.getElementById('keyModal').classList.remove('hidden');
            document.getElementById('keyInput').focus();
        }

        function hideKeyModal() {
            document.getElementById('keyModal').classList.add('hidden');
        }

        // Event Listeners
        function setupEventListeners() {
            // API Key modal
            document.getElementById('keySubmit').onclick = function() {
                const key = document.getElementById('keyInput').value.trim();
                if (key) {
                    apiKey = key;
                    localStorage.setItem('dashboardApiKey', apiKey);
                    hideKeyModal();
                    startDataFetching();
                }
            };

            document.getElementById('keyInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('keySubmit').click();
                }
            });

            // Trade filters
            document.getElementById('filterAll').onclick = () => setFilter('all');
            document.getElementById('filterOpen').onclick = () => setFilter('open');
            document.getElementById('filterClosed').onclick = () => setFilter('closed');
            document.getElementById('dirAll').onclick = () => setDirFilter('all');
            document.getElementById('dirUp').onclick = () => setDirFilter('UP');
            document.getElementById('dirDown').onclick = () => setDirFilter('DOWN');

            // Signal filters
            document.getElementById('sigFilterAll').onclick = () => setSigFilter('all');
            document.getElementById('sigFilterLarge').onclick = () => setSigFilter('large');
            document.getElementById('sigFilterSmall').onclick = () => setSigFilter('small');
        }

        // Filter functions
        function setFilter(filter) {
            currentFilter = filter;
            updateFilterButtons();
            renderTrades();
        }

        function setDirFilter(filter) {
            currentDirFilter = filter;
            updateFilterButtons();
            renderTrades();
        }

        function setSigFilter(filter) {
            currentSigFilter = filter;
            updateSigFilterButtons();
            renderSignals();
        }

        function updateFilterButtons() {
            const filterButtons = {
                all: document.getElementById('filterAll'),
                open: document.getElementById('filterOpen'),
                closed: document.getElementById('filterClosed')
            };
            const dirButtons = {
                all: document.getElementById('dirAll'),
                UP: document.getElementById('dirUp'),
                DOWN: document.getElementById('dirDown')
            };

            // Update filter buttons
            Object.entries(filterButtons).forEach(([key, btn]) => {
                if (key === currentFilter) {
                    btn.className = 'px-2 py-1 rounded bg-gray-700 text-white';
                } else {
                    btn.className = 'px-2 py-1 rounded text-gray-400 hover:text-white';
                }
            });

            // Update direction buttons
            Object.entries(dirButtons).forEach(([key, btn]) => {
                if (key === currentDirFilter) {
                    btn.className = 'px-2 py-1 rounded bg-gray-700 text-white';
                } else {
                    btn.className = 'px-2 py-1 rounded text-gray-400 hover:text-white';
                }
            });
        }

        function updateSigFilterButtons() {
            const buttons = {
                all: document.getElementById('sigFilterAll'),
                large: document.getElementById('sigFilterLarge'),
                small: document.getElementById('sigFilterSmall')
            };

            Object.entries(buttons).forEach(([key, btn]) => {
                if (key === currentSigFilter) {
                    btn.className = 'px-2 py-1 rounded bg-gray-700 text-white';
                } else {
                    btn.className = 'px-2 py-1 rounded text-gray-400 hover:text-white';
                }
            });
        }

        // API calls
        async function apiCall(endpoint) {
            if (!apiKey) return null;
            
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'X-API-Key': apiKey
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        // Invalid API key
                        localStorage.removeItem('dashboardApiKey');
                        apiKey = '';
                        showKeyModal();
                        return null;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`API call failed (${endpoint}):`, error);
                return null;
            }
        }

        // Utility functions
        function formatCurrency(value, digits = 2) {
            const num = Number(value) || 0;
            const sign = num >= 0 ? '+' : '';
            return `${sign}$${num.toFixed(digits)}`;
        }

        function formatPercent(value) {
            return `${((Number(value) || 0) * 100).toFixed(1)}%`;
        }

        function formatTime(seconds) {
            const s = Number(seconds) || 0;
            if (s < 60) return `${s.toFixed(0)}s`;
            if (s < 3600) return `${(s / 60).toFixed(1)}m`;
            return `${(s / 3600).toFixed(1)}h`;
        }

        function timeAgo(timestamp) {
            const diff = (Date.now() - new Date(timestamp).getTime()) / 1000;
            if (diff < 60) return `${Math.floor(diff)}s ago`;
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }

        // Data fetching
        function startDataFetching() {
            // Initial fetch
            fetchStatus();
            fetchStats();
            fetchTrades();
            fetchSignals();
            fetchEquity();
            fetchStrategies();

            // Set up intervals
            setInterval(fetchStatus, 10000);  // Status + positions every 10s
            setInterval(() => {
                fetchTrades();
                fetchStats();
            }, 30000);  // Trades + stats every 30s
            setInterval(fetchSignals, 15000);  // Signals every 15s
            setInterval(fetchEquity, 60000);  // Equity every 60s
        }

        // Status fetching and rendering
        async function fetchStatus() {
            const data = await apiCall('/api/status');
            if (data) renderStatus(data);
        }

        function renderStatus(status) {
            const age = (Date.now() - new Date(status.ts || Date.now()).getTime()) / 1000;
            const alive = age < 120;
            const mode = (status.executor && status.executor.paper) ? 'PAPER' : 'LIVE';

            // Update status indicator
            const statusDot = document.getElementById('statusDot');
            statusDot.className = `w-2 h-2 rounded-full ${alive ? 'bg-green-500' : 'bg-red-500'}`;

            // Update mode badge
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = mode;
            statusBadge.className = mode === 'PAPER' 
                ? 'px-2 py-0.5 rounded border text-xs font-semibold bg-yellow-500/20 text-yellow-400 border-yellow-500/30'
                : 'px-2 py-0.5 rounded border text-xs font-semibold bg-green-500/20 text-green-400 border-green-500/30';

            // Update stats
            document.getElementById('uptime').textContent = formatTime(Number(status.uptime_s) || 0);
            document.getElementById('msgPerSec').textContent = (Number(status.msg_per_sec) || 0).toFixed(0);
            document.getElementById('signals').textContent = (Number(status.signals_total) || 0).toLocaleString();
            
            const executor = status.executor || {};
            document.getElementById('openPositions').textContent = String(Number(executor.open_positions) || 0);
            
            const dailyPnl = Number(executor.daily_pnl) || 0;
            const dailyPnlEl = document.getElementById('dailyPnl');
            dailyPnlEl.textContent = formatCurrency(dailyPnl);
            dailyPnlEl.className = `font-mono font-semibold ${dailyPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;

            // Update cooldown indicator
            const cooldownBadge = document.getElementById('cooldownBadge');
            if (executor.cooldown_active) {
                cooldownBadge.classList.remove('hidden');
            } else {
                cooldownBadge.classList.add('hidden');
            }
        }

        // Stats fetching and rendering
        async function fetchStats() {
            const data = await apiCall('/api/stats');
            if (data) renderStats(data);
        }

        function renderStats(stats) {
            // Update total P&L in status bar
            const totalPnl = Number(stats.total_pnl) || 0;
            const totalPnlEl = document.getElementById('totalPnl');
            totalPnlEl.textContent = formatCurrency(totalPnl);
            totalPnlEl.className = `font-mono font-semibold ${totalPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;

            // Render metrics grid
            const metrics = [
                { label: 'Total Trades', value: (Number(stats.total_trades) || 0).toLocaleString() },
                { 
                    label: 'Win Rate', 
                    value: formatPercent(Number(stats.win_rate) || 0), 
                    color: (Number(stats.win_rate) || 0) >= 0.5 ? 'text-green-400' : 'text-red-400' 
                },
                { 
                    label: 'Profit Factor', 
                    value: Number(stats.profit_factor) === Infinity ? 'âˆž' : (Number(stats.profit_factor) || 0).toFixed(2),
                    color: (Number(stats.profit_factor) || 0) >= 1 ? 'text-green-400' : 'text-red-400' 
                },
                { label: 'Avg Win', value: formatCurrency(Number(stats.avg_win) || 0), color: 'text-green-400' },
                { label: 'Avg Loss', value: formatCurrency(Number(stats.avg_loss) || 0), color: 'text-red-400' },
                { label: 'Avg Hold', value: formatTime(Number(stats.avg_hold_time) || 0) },
                { label: 'Max Drawdown', value: formatCurrency(Number(stats.max_drawdown) || 0), color: 'text-red-400' },
                { label: 'Best Trade', value: formatCurrency(Number(stats.best_trade) || 0), color: 'text-green-400' },
                { label: 'Worst Trade', value: formatCurrency(Number(stats.worst_trade) || 0), color: 'text-red-400' },
                { 
                    label: 'Total P&L', 
                    value: formatCurrency(totalPnl),
                    color: totalPnl >= 0 ? 'text-green-400' : 'text-red-400' 
                }
            ];

            const grid = document.getElementById('metricsGrid');
            grid.innerHTML = metrics.map(m => `
                <div class="bg-gray-800/50 rounded-lg p-4">
                    <div class="text-gray-500 text-xs mb-1">${m.label}</div>
                    <div class="font-mono text-xl font-bold ${m.color || 'text-white'}">${m.value}</div>
                </div>
            `).join('');
        }

        // Trades fetching and rendering
        async function fetchTrades() {
            const data = await apiCall('/api/trades?limit=500');
            if (data && data.trades) {
                allTrades = data.trades || [];
                renderTrades();
            }
        }

        function renderTrades() {
            const filtered = (allTrades || []).filter(trade => {
                if (currentFilter === 'open' && trade.status !== 'open') return false;
                if (currentFilter === 'closed' && trade.status === 'open') return false;
                if (currentDirFilter !== 'all' && trade.direction !== currentDirFilter) return false;
                return true;
            });

            const container = document.getElementById('tradesContainer');
            if ((filtered || []).length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Collecting data...</div>';
                return;
            }

            container.innerHTML = (filtered || []).slice(0, 200).map(trade => {
                const isExpanded = expandedTrade === trade.id;
                const pnl = Number(trade.pnl) || 0;
                const entryPrice = Number(trade.entry_price) || 0;
                const exitPrice = Number(trade.exit_price) || 0;
                const holdTime = Number(trade.hold_time_s) || 0;
                const sizeUsd = Number(trade.size_usd) || 0;
                const shares = Number(trade.shares) || 0;
                const signalChange = Number(trade.signal_change_cents) || 0;
                const signalWindow = Number(trade.signal_window_s) || 0;

                return `
                    <div>
                        <div class="grid grid-cols-[60px_80px_1fr_60px_70px_70px_80px_70px_70px_90px] gap-2 px-3 py-2 text-xs items-center cursor-pointer hover:bg-gray-800/50 border-b border-gray-800/50 ${isExpanded ? 'bg-gray-800/30' : ''}"
                             onclick="toggleTrade(${trade.id})">
                            <span class="font-mono text-gray-400">#${trade.id || 0}</span>
                            <span class="text-gray-400" title="${trade.timestamp || ''}">${timeAgo(trade.timestamp || '')}</span>
                            <span class="truncate" title="${trade.market_question || ''}">${trade.market_question || ''}</span>
                            <span class="${(trade.direction === 'UP') ? 'text-green-400 font-semibold' : 'text-red-400 font-semibold'}">${trade.direction || ''}</span>
                            <span class="font-mono">${entryPrice.toFixed(3)}</span>
                            <span class="font-mono">${exitPrice ? exitPrice.toFixed(3) : 'â€”'}</span>
                            <span class="font-mono font-semibold ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}">${formatCurrency(pnl)}</span>
                            <span class="${trade.status === 'open' ? 'pulse-open text-yellow-400' : pnl > 0 ? 'text-green-400' : 'text-red-400'}">
                                ${trade.status === 'open' ? 'â— OPEN' : pnl > 0 ? 'WON' : 'LOST'}
                            </span>
                            <span class="font-mono text-gray-400">${formatTime(holdTime)}</span>
                            <span class="text-gray-500 truncate">${trade.exit_reason || 'â€”'}</span>
                        </div>
                        ${isExpanded ? `
                            <div class="px-6 py-3 bg-gray-800/20 text-xs grid grid-cols-4 gap-4 border-b border-gray-800">
                                <div><span class="text-gray-500">Market: </span>${trade.market_question || ''}</div>
                                <div><span class="text-gray-500">Outcome: </span>${trade.outcome || ''}</div>
                                <div><span class="text-gray-500">Size: </span>$${sizeUsd.toFixed(2)}</div>
                                <div><span class="text-gray-500">Shares: </span>${shares.toFixed(2)}</div>
                                <div><span class="text-gray-500">Signal Î”: </span>${signalChange}Â¢</div>
                                <div><span class="text-gray-500">Window: </span>${signalWindow}s</div>
                                <div><span class="text-gray-500">Source: </span>${trade.source || ''}</div>
                                <div><span class="text-gray-500">Paper: </span>${trade.paper ? 'Yes' : 'No'}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function toggleTrade(id) {
            expandedTrade = expandedTrade === id ? null : id;
            renderTrades();
        }

        // Signals fetching and rendering
        async function fetchSignals() {
            const data = await apiCall('/api/signals?limit=500');
            if (data && data.signals) {
                allSignals = data.signals || [];
                renderSignals();
            }
        }

        function renderSignals() {
            const filtered = (allSignals || []).filter(signal => {
                const changeC = Math.abs(Number(signal.change_c) || 0);
                if (currentSigFilter === 'large') return changeC >= 5;
                if (currentSigFilter === 'small') return changeC < 5;
                return true;
            });

            const container = document.getElementById('signalsContainer');
            if ((filtered || []).length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">Collecting signals...</div>';
                return;
            }

            container.innerHTML = (filtered || []).slice(0, 200).map(signal => {
                const changeC = Number(signal.change_c) || 0;
                const priceNow = Number(signal.price_now) || 0;
                const ts = Number(signal.ts) || 0;
                const intensity = Math.min(Math.abs(changeC) / 20, 1);
                const time = new Date(ts * 1000).toLocaleTimeString();
                const tokenId = (signal.token_id || '').slice(0, 8) + 'â€¦';

                return `
                    <div class="grid grid-cols-[100px_80px_1fr_50px_70px_60px] gap-2 px-3 py-1.5 text-xs items-center border-b border-gray-800/30"
                         title="${signal.market || ''}">
                        <span class="text-gray-400 font-mono">${time}</span>
                        <span class="truncate text-gray-400">${tokenId}</span>
                        <span class="truncate">${signal.market || ''}</span>
                        <span class="${signal.direction === 'UP' ? 'text-green-400' : 'text-red-400'}">${signal.direction || ''}</span>
                        <span class="font-mono font-semibold" 
                              style="opacity: ${0.4 + intensity * 0.6}; color: ${changeC >= 0 ? '#22c55e' : '#ef4444'}">
                            ${changeC >= 0 ? '+' : ''}${changeC.toFixed(1)}Â¢
                        </span>
                        <span class="font-mono text-gray-400">${priceNow.toFixed(3)}</span>
                    </div>
                `;
            }).join('');
        }

        // Chart fetching and rendering
        async function fetchEquity() {
            const data = await apiCall('/api/pnl');
            if (data && data.series) {
                renderCharts(data.series || []);
            }
        }

        async function fetchStrategies() {
            const data = await apiCall('/api/strategies');
            if (data) {
                renderStrategies(data || {});
            }
        }

        function renderStrategies(strategies) {
            const container = document.getElementById('strategiesContainer');
            const strategyList = Object.entries(strategies || {});
            
            if (strategyList.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No strategy data available</div>';
                return;
            }

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${strategyList.map(([name, stats]) => `
                        <div class="bg-gray-800/50 rounded-lg p-4">
                            <div class="font-semibold mb-2">${name}</div>
                            <div class="text-sm space-y-1">
                                <div>Trades: ${Number(stats.total_trades) || 0}</div>
                                <div>Win Rate: ${formatPercent(Number(stats.win_rate) || 0)}</div>
                                <div class="${(Number(stats.total_pnl) || 0) >= 0 ? 'text-green-400' : 'text-red-400'}">
                                    P&L: ${formatCurrency(Number(stats.total_pnl) || 0)}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderCharts(series) {
            const data = series || [];
            if (data.length === 0) return;

            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};

            // Cumulative P&L Chart
            renderPnlChart(data);
            
            // Rolling Win Rate Chart (need at least 50 trades)
            if (data.length >= 50) {
                renderWinRateChart(data);
            }
            
            // P&L Histogram
            renderHistogramChart(data);
        }

        function renderPnlChart(data) {
            const ctx = document.getElementById('pnlChart').getContext('2d');
            charts.pnl = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: (data || []).map((_, i) => i + 1),
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: (data || []).map(d => Number(d.cum_pnl) || 0),
                        borderColor: '#22c55e',
                        backgroundColor: 'transparent',
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: '#1f2937' },
                            ticks: { color: '#6b7280' }
                        },
                        y: {
                            grid: { color: '#1f2937' },
                            ticks: { 
                                color: '#6b7280',
                                callback: function(value) { return '$' + value; }
                            }
                        }
                    }
                }
            });
        }

        function renderWinRateChart(data) {
            // Calculate rolling win rate
            const rolling = [];
            for (let i = 49; i < data.length; i++) {
                const window = data.slice(i - 49, i + 1);
                const wins = (window || []).filter(p => (Number(p.pnl) || 0) > 0).length;
                rolling.push({ trade: i + 1, winRate: wins / 50 });
            }

            const ctx = document.getElementById('winRateChart').getContext('2d');
            charts.winRate = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: (rolling || []).map(r => r.trade),
                    datasets: [{
                        label: 'Win Rate',
                        data: (rolling || []).map(r => r.winRate),
                        borderColor: '#3b82f6',
                        backgroundColor: 'transparent',
                        tension: 0.1,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: '#1f2937' },
                            ticks: { color: '#6b7280' }
                        },
                        y: {
                            min: 0,
                            max: 1,
                            grid: { color: '#1f2937' },
                            ticks: { 
                                color: '#6b7280',
                                callback: function(value) { return (value * 100).toFixed(0) + '%'; }
                            }
                        }
                    }
                }
            });
        }

        function renderHistogramChart(data) {
            const pnls = (data || []).map(d => Number(d.pnl) || 0);
            if (pnls.length === 0) return;

            const min = Math.min(...pnls);
            const max = Math.max(...pnls);
            const bucketCount = 30;
            const step = (max - min) / bucketCount || 1;
            
            const buckets = [];
            for (let i = 0; i < bucketCount; i++) {
                const lo = min + i * step;
                const hi = lo + step;
                const count = pnls.filter(p => p >= lo && (i === bucketCount - 1 ? p <= hi : p < hi)).length;
                buckets.push({ range: lo.toFixed(2), count });
            }

            const ctx = document.getElementById('histogramChart').getContext('2d');
            charts.histogram = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: (buckets || []).map(b => b.range),
                    datasets: [{
                        label: 'Count',
                        data: (buckets || []).map(b => b.count),
                        backgroundColor: '#6366f1',
                        borderRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { color: '#1f2937' },
                            ticks: { 
                                color: '#6b7280',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            grid: { color: '#1f2937' },
                            ticks: { color: '#6b7280' }
                        }
                    }
                }
            });
        }

        // Make functions globally available
        window.toggleTrade = toggleTrade;
    </script>
</body>
</html>