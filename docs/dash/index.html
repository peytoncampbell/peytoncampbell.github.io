<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title>BTC Dashboard</title>
<link rel="icon" href="/dash/favicon.ico">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
:root{--bg:#0d1117;--surface:#161b22;--border:#21262d;--border2:#30363d;--text:#c9d1d9;--text2:#8b949e;--text3:#484f58;--white:#f0f6fc;--blue:#58a6ff;--green:#3fb950;--red:#f85149;--orange:#d29922}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-size:13px;padding:12px 16px;max-width:1400px;margin:0 auto}
/* Header */
.hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.hdr h1{font-size:1.1rem;color:var(--white);font-weight:700;letter-spacing:-.3px}
.hdr-right{display:flex;align-items:center;gap:14px}
.health{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text2)}
.dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.dot-g{background:var(--green)}.dot-r{background:var(--red)}.dot-x{background:var(--text3)}
.refresh{font-size:10px;color:var(--text3)}
/* Tabs */
.tabs{display:flex;gap:0;margin-bottom:12px;border-bottom:1px solid var(--border2)}
.tab{padding:7px 18px;cursor:pointer;font-weight:600;font-size:12px;color:var(--text2);border-bottom:2px solid transparent;transition:all .15s}
.tab:hover{color:var(--text)}.tab.on{color:var(--blue);border-bottom-color:var(--blue)}
.pane{display:none}.pane.on{display:block}
/* Cards */
.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px}
.card-l{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.6px;margin-bottom:2px}
.card-v{font-size:1.25rem;font-weight:700;color:var(--white)}
.g{color:var(--green)}.r{color:var(--red)}
/* Chart */
.chart-box{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:12px;height:200px;position:relative}
/* Tables */
.tbl-wrap{overflow-x:auto;border-radius:8px;border:1px solid var(--border);margin-bottom:12px;max-height:340px;overflow-y:auto}
table{width:100%;border-collapse:collapse;background:var(--surface)}
th,td{padding:5px 10px;text-align:left;font-size:12px;border-bottom:1px solid var(--border);white-space:nowrap}
th{background:var(--bg);color:var(--text2);cursor:pointer;user-select:none;position:sticky;top:0;z-index:1;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.4px}
th:hover{color:var(--text)}
.badge{display:inline-block;padding:1px 7px;border-radius:10px;font-size:10px;font-weight:600}
.b-a{background:#23812e22;color:var(--green)}.b-s{background:#484f5822;color:var(--text3)}.b-l{background:#58a6ff22;color:var(--blue)}
/* Feed */
.feed{display:flex;flex-direction:column;gap:4px;max-height:500px;overflow-y:auto}
.fi{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 10px}
.fi-icon{width:22px;height:22px;border-radius:50%;flex-shrink:0}
.fi-body{flex:1;min-width:0}
.fi-title{font-size:11px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fi-sub{font-size:10px;color:var(--text2);margin-top:1px}
.fi-amt{font-size:12px;font-weight:600;white-space:nowrap;margin-left:8px}
.fi-tag{font-size:9px;padding:2px 6px;border-radius:8px;white-space:nowrap;margin-left:6px;font-weight:600}
.t-claim{background:#1a3a2a;color:var(--green)}.t-buy{background:#1c2a3a;color:var(--blue)}.t-other{background:#2d2a1a;color:var(--orange)}
/* Layout helpers */
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.section-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;font-weight:600}
@media(max-width:768px){.cards{grid-template-columns:repeat(2,1fr)}.row{grid-template-columns:1fr}.chart-box{height:180px}}
@media(max-width:480px){body{padding:8px}.card-v{font-size:1rem}.tabs{overflow-x:auto}}
</style>
</head>
<body>
<div class="hdr">
  <h1>‚Çø BTC Trading Bot</h1>
  <div class="hdr-right">
    <div class="health"><span class="dot dot-x" id="h-sig"></span>Signals</div>
    <div class="health"><span class="dot dot-x" id="h-pap"></span>Paper</div>
    <div class="health"><span class="dot dot-x" id="h-liv"></span>Live</div>
    <div class="health"><span class="dot dot-x" id="h-api"></span>API</div>
    <span class="refresh" id="ref">‚Äî</span>
  </div>
</div>

<div class="tabs">
  <div class="tab on" onclick="sw('paper')">üìä Paper Trading</div>
  <div class="tab" onclick="sw('live')">üî¥ Live Trading</div>
</div>

<div class="pane on" id="p-paper">
  <div class="cards" id="pc"></div>
  <div class="row">
    <div>
      <div class="section-label">Equity Curve</div>
      <div class="chart-box"><canvas id="pChart"></canvas></div>
    </div>
    <div>
      <div class="section-label">Recent Signals</div>
      <div class="tbl-wrap" style="max-height:224px"><table id="sig-tbl"><thead><tr><th>Time</th><th>Strategy</th><th>Dir</th><th>Price</th><th>Result</th></tr></thead><tbody></tbody></table></div>
    </div>
  </div>
  <div class="section-label">Strategy Performance</div>
  <div class="tbl-wrap"><table id="strat-tbl"><thead><tr></tr></thead><tbody></tbody></table></div>
</div>

<div class="pane" id="p-live">
  <div class="cards" id="lc"></div>
  <div class="section-label">Activity</div>
  <div class="feed" id="feed"></div>
</div>

<script>
const API='https://dashboard.peytoncampbell.ca',KEY='65bc4d4ad01756a528c74480067c330da9461584b3b7347e',H={headers:{'X-API-Key':KEY}};
let pChart,strats=[],ss={col:'pnl',asc:false};
async function q(p){try{const r=await fetch(API+p,H);if(!r.ok)throw r;return r.json()}catch{return null}}
function sw(t){document.querySelectorAll('.tab').forEach((e,i)=>e.classList.toggle('on',i===(t==='paper'?0:1)));document.querySelectorAll('.pane').forEach((e,i)=>e.classList.toggle('on',i===(t==='paper'?0:1)))}
const f2=(v,d=2)=>v==null?'‚Äî':Number(v).toFixed(d);
const f$=v=>v==null?'‚Äî':'$'+f2(v);
const fP=v=>v==null?'‚Äî':f2(v,1)+'%';
const pc=v=>v>=0?'g':'r';

// Strategy table columns
const cols=[
  {k:'name',l:'Strategy',f:v=>v},
  {k:'status',l:'Status',f:v=>`<span class="badge ${v==='ACTIVE'?'b-a':v==='LEGACY'?'b-l':'b-s'}">${v}</span>`},
  {k:'pnl',l:'P&L',f:v=>`<span class="${pc(v)}">${f$(v)}</span>`,n:1},
  {k:'wr',l:'WR%',f:v=>fP(v),n:1},
  {k:'pdd',l:'P/DD',f:v=>f2(v),n:1},
  {k:'trades',l:'#',f:v=>v,n:1}
];

function merge(strategies,stats){
  const sm=Object.fromEntries((stats||[]).map(s=>[s.strategy_name||s.name,s]));
  const im=Object.fromEntries((strategies||[]).map(s=>[s.name,s]));
  const seen=new Set(),list=[];
  for(const s of(stats||[])){const n=s.strategy_name||s.name;seen.add(n);const i=im[n];list.push({name:n,status:i?i.status:'LEGACY',pnl:s.total_pnl||0,wr:(s.win_rate||0)*100,pdd:s.pdd_ratio||0,trades:s.total_trades||0})}
  for(const s of strategies)if(!seen.has(s.name))list.push({name:s.name,status:s.status,pnl:0,wr:0,pdd:0,trades:0});
  return list;
}

function renderStrats(rows){
  const t=document.getElementById('strat-tbl'),th=t.querySelector('thead tr');
  th.innerHTML=cols.map(c=>{let a='';if(ss.col===c.k)a=`<span style="margin-left:3px;font-size:9px">${ss.asc?'‚ñ≤':'‚ñº'}</span>`;return`<th data-k="${c.k}">${c.l}${a}</th>`}).join('');
  th.querySelectorAll('th').forEach(e=>e.onclick=()=>{const k=e.dataset.k;if(ss.col===k)ss.asc=!ss.asc;else{ss.col=k;ss.asc=false}renderStrats(rows)});
  const sorted=[...rows];if(ss.col){const c=cols.find(x=>x.k===ss.col);sorted.sort((a,b)=>{let av=a[ss.col],bv=b[ss.col];if(c?.n){av=+av||0;bv=+bv||0}else{av=String(av).toLowerCase();bv=String(bv).toLowerCase()}return ss.asc?(av>bv?1:-1):(av<bv?1:-1)})}
  t.querySelector('tbody').innerHTML=sorted.map(r=>`<tr>${cols.map(c=>`<td>${c.f(r[c.k])}</td>`).join('')}</tr>`).join('');
}

function renderSigs(sigs){
  document.getElementById('sig-tbl').querySelector('tbody').innerHTML=(sigs||[]).slice(0,20).map(s=>{
    const oc=s.outcome==='WIN'?'g':s.outcome==='LOSS'?'r':'';
    const t=s.timestamp?new Date(s.timestamp).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}):'‚Äî';
    return`<tr><td>${t}</td><td>${s.strategy_name||'‚Äî'}</td><td>${s.direction||'‚Äî'}</td><td>${f$(s.buy_price)}</td><td class="${oc}">${s.outcome||'‚è≥'}</td></tr>`;
  }).join('');
}

function mkChart(ctx,data){
  const pts=(data||[]).map(d=>({x:new Date(d.t),y:d.b}));
  return new Chart(ctx,{type:'line',data:{datasets:[{data:pts,borderColor:'#58a6ff',backgroundColor:'rgba(88,166,255,.06)',fill:true,pointRadius:0,tension:.3,borderWidth:1.5}]},options:{responsive:true,maintainAspectRatio:false,animation:false,interaction:{intersect:false,mode:'index'},plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>'$'+c.parsed.y.toFixed(2)}}},scales:{x:{type:'time',grid:{color:'#161b22'},ticks:{color:'var(--text3)',maxTicksLimit:6,font:{size:10}}},y:{grid:{color:'#161b22'},ticks:{color:'var(--text3)',font:{size:10},callback:v=>'$'+v}}}}});
}

async function refresh(){
  const[health,strategies,pStats,pos,sigs,eq]=await Promise.all([
    q('/api/health'),q('/api/strategies'),q('/api/stats?mode=paper'),
    q('/api/positions'),q('/api/signals?limit=50'),q('/api/equity?mode=paper&points=300')
  ]);
  // Health dots
  if(health){
    const now=Date.now();
    const chk=(id,o)=>{const ts=o&&(o.last_heartbeat||o.ts||o);document.getElementById(id).className='dot '+(ts&&(now-new Date(ts).getTime())<120000?'dot-g':'dot-r')};
    chk('h-sig',health.signal_engine);chk('h-pap',health.paper_trader);chk('h-liv',health.live_trader);
    document.getElementById('h-api').className='dot dot-g';
  }
  // Paper cards
  strats=(strategies?.strategies)||[];
  const ps=(pStats?.stats)||[];
  const totalPnl=ps.reduce((a,s)=>a+(s.total_pnl||0),0);
  const totalTrades=ps.reduce((a,s)=>a+(s.total_trades||0),0);
  const wins=ps.reduce((a,s)=>a+(s.wins||0),0);
  const wr=totalTrades?(wins/totalTrades*100):0;
  document.getElementById('pc').innerHTML=`
    <div class="card"><div class="card-l">Total P&L</div><div class="card-v ${pc(totalPnl)}">${f$(totalPnl)}</div></div>
    <div class="card"><div class="card-l">Win Rate</div><div class="card-v">${fP(wr)}</div></div>
    <div class="card"><div class="card-l">Trades</div><div class="card-v">${totalTrades.toLocaleString()}</div></div>
    <div class="card"><div class="card-l">Strategies</div><div class="card-v">${ps.length}</div></div>`;
  // Chart
  const pe=(eq?.equity)||[];
  if(!pChart)pChart=mkChart(document.getElementById('pChart'),pe);
  else{pChart.data.datasets[0].data=pe.map(d=>({x:new Date(d.t),y:d.b}));pChart.update('none')}
  // Signals
  renderSigs((sigs?.signals)||[]);
  // Strategy table
  renderStrats(merge(strats,ps));
  // Live tab
  if(pos){
    const s=pos.summary||{};
    document.getElementById('lc').innerHTML=`
      <div class="card"><div class="card-l">Portfolio</div><div class="card-v">${s.balance!=null?f$(s.balance):'‚Äî'}</div></div>
      <div class="card"><div class="card-l">Cash</div><div class="card-v">${s.cash_balance!=null?f$(s.cash_balance):'‚Äî'}</div></div>
      <div class="card"><div class="card-l">Total P&L</div><div class="card-v ${pc(s.total_pnl)}">${f$(s.total_pnl)}</div></div>
      <div class="card"><div class="card-l">Redeemed</div><div class="card-v g">${f$(s.total_redeemed)}</div></div>
      <div class="card"><div class="card-l">Positions</div><div class="card-v">${s.positions}</div></div>`;
    const now=Date.now()/1000;
    document.getElementById('feed').innerHTML=(pos.activity||[]).map(a=>{
      const ic=a.icon?`<img class="fi-icon" src="${a.icon}">`:'';
      if(a.type==='REDEEM')return`<div class="fi">${ic}<div class="fi-body"><div class="fi-title">${a.title}</div><div class="fi-sub">Claimed</div></div><div class="fi-amt g">+${f$(a.usdc)}</div><div class="fi-tag t-claim">Claimed</div></div>`;
      if(a.type==='TRADE'&&a.side==='BUY'){const m=Math.round((now-a.timestamp)/60);const ago=m<60?m+'m':Math.round(m/60)+'h';return`<div class="fi">${ic}<div class="fi-body"><div class="fi-title">${a.title}</div><div class="fi-sub">Bought ${Math.round(a.size)} ${a.outcome} at ${Math.round(a.price*100)}¬¢</div></div><div class="fi-amt" style="color:var(--text2)">-${f$(a.usdc)}</div><div class="fi-tag t-buy">${ago} ago</div></div>`}
      return`<div class="fi">${ic}<div class="fi-body"><div class="fi-title">${a.title}</div><div class="fi-sub">${a.type} ${a.outcome||''}</div></div><div class="fi-amt">${f$(a.usdc)}</div><div class="fi-tag t-other">${a.type}</div></div>`;
    }).join('');
  }
  document.getElementById('ref').textContent=new Date().toLocaleTimeString()+' ¬∑ 30s';
}
refresh();setInterval(refresh,30000);
</script>
</body>
</html>
