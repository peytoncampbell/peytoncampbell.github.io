<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BTC Trading Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0d1117;--card:#161b22;--border:#30363d;--text:#e6edf3;--muted:#8b949e;--green:#3fb950;--red:#f85149;--blue:#58a6ff;--yellow:#d29922}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;line-height:1.5;padding:16px;max-width:1400px;margin:0 auto}
h1{font-size:1.4rem;font-weight:600}
.header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.header small{color:var(--muted);font-size:.8rem}
/* Health bar */
.health{display:flex;align-items:center;gap:12px;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px 16px;margin-bottom:16px;flex-wrap:wrap;font-size:.85rem}
.dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.dot.ok{background:var(--green)}.dot.err{background:var(--red)}
/* Tabs */
.tabs{display:flex;gap:4px;margin-bottom:16px}
.tabs button{background:var(--card);border:1px solid var(--border);color:var(--muted);padding:6px 18px;border-radius:6px;cursor:pointer;font-size:.85rem}
.tabs button.active{color:var(--text);border-color:var(--blue);background:#1c2333}
/* Cards */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:14px}
.card .label{font-size:.75rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.card .value{font-size:1.4rem;font-weight:600;margin-top:2px}
.pos{color:var(--green)}.neg{color:var(--red)}
/* Chart */
.chart-wrap{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px}
.chart-wrap h2{font-size:1rem;margin-bottom:8px}
/* Table */
.tbl-wrap{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px;overflow-x:auto}
.tbl-wrap h2{font-size:1rem;margin-bottom:8px}
table{width:100%;border-collapse:collapse;font-size:.83rem}
th,td{text-align:left;padding:8px 10px;border-bottom:1px solid var(--border)}
th{color:var(--muted);cursor:pointer;user-select:none;white-space:nowrap}
th:hover{color:var(--text)}
td{white-space:nowrap}
/* Signals */
.signals{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:16px}
.signals h2{font-size:1rem;margin-bottom:8px}
.sig{display:flex;gap:10px;padding:6px 0;border-bottom:1px solid var(--border);font-size:.82rem;flex-wrap:wrap}
.sig:last-child{border-bottom:none}
.sig .ts{color:var(--muted);min-width:130px}
.sig .dir{font-weight:600;min-width:50px}
.dir.LONG{color:var(--green)}.dir.SHORT{color:var(--red)}
.sig .conf{color:var(--yellow)}
.loading{color:var(--muted);font-style:italic;padding:20px 0}
</style>
</head>
<body>

<div class="header">
  <h1>₿ BTC Trading Bot</h1>
  <small id="refreshTime"></small>
</div>

<div class="health" id="health"><span class="loading">Loading health...</span></div>

<div class="tabs">
  <button class="active" onclick="setMode('paper')">Paper</button>
  <button onclick="setMode('live')">Live</button>
</div>

<div class="cards" id="cards"><span class="loading">Loading stats...</span></div>

<div class="chart-wrap">
  <h2>Equity Curve</h2>
  <canvas id="equityChart" height="260"></canvas>
</div>

<div class="tbl-wrap">
  <h2>Strategies</h2>
  <div id="stratTable"><span class="loading">Loading...</span></div>
</div>

<div class="signals">
  <h2>Recent Signals</h2>
  <div id="signalFeed"><span class="loading">Loading...</span></div>
</div>

<script>
const API='https://dashboard.peytoncampbell.ca',KEY='65bc4d4ad01756a528c74480067c330da9461584b3b7347e';
let mode='paper',chart=null,sortCol='pnl',sortAsc=false,statsData=[];

const F=url=>fetch(API+url,{headers:{'X-API-Key':KEY}}).then(r=>r.json());
const $=id=>document.getElementById(id);
const fmt=v=>v==null?'—':Number(v).toFixed(2);
const pct=v=>v==null?'—':(Number(v)*100).toFixed(1)+'%';
const cls=v=>v>0?'pos':v<0?'neg':'';
const ts=s=>{if(!s)return'—';const d=new Date(s);return d.toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})};

function setMode(m){
  mode=m;
  document.querySelectorAll('.tabs button').forEach(b=>b.classList.toggle('active',b.textContent.toLowerCase()===m));
  refresh();
}

async function refresh(){
  $('refreshTime').textContent='Updated: '+new Date().toLocaleTimeString();
  try{await Promise.all([loadHealth(),loadStats(),loadEquity(),loadStrategies(),loadSignals()])}catch(e){console.error(e)}
}

async function loadHealth(){
  const d=await F('/api/health');
  const ok=d.status==='ok'||d.status==='healthy';
  const se=d.signal_engine||{};
  $('health').innerHTML=`
    <span class="dot ${ok?'ok':'err'}"></span>
    <strong>${ok?'Healthy':'Unhealthy'}</strong>
    <span>Last signal: ${ts(se.last_heartbeat)}</span>
    <span>Signals emitted: ${se.signals_emitted??'—'}</span>
    <span>Window: ${se.window??'—'} / Min: ${se.minute??'—'}</span>`;
}

async function loadStats(){
  const d=await F('/api/stats?mode='+mode);
  statsData=d.stats||[];
  let bal=0,pnl=0,wins=0,trades=0;
  statsData.forEach(s=>{pnl+=s.pnl||0;wins+=s.wins||0;trades+=s.trades||0});
  const wr=trades?wins/trades:0;
  $('cards').innerHTML=`
    <div class="card"><div class="label">Balance</div><div class="value">$${fmt(bal||pnl)}</div></div>
    <div class="card"><div class="label">Total P&L</div><div class="value ${cls(pnl)}">$${fmt(pnl)}</div></div>
    <div class="card"><div class="label">Win Rate</div><div class="value">${pct(wr)}</div></div>
    <div class="card"><div class="label">Total Trades</div><div class="value">${trades}</div></div>
    <div class="card"><div class="label">Strategies</div><div class="value">${statsData.length}</div></div>`;
  renderStratTable();
}

function renderStratTable(){
  const s=[...statsData].sort((a,b)=>{let v=0;if(sortCol==='strategy')v=(a.strategy||'').localeCompare(b.strategy||'');else v=(a[sortCol]||0)-(b[sortCol]||0);return sortAsc?v:-v});
  const arrow=c=>sortCol===c?(sortAsc?' ↑':' ↓'):'';
  const cols=[['strategy','Strategy'],['trades','Trades'],['win_rate','Win%'],['pnl','P&L'],['max_drawdown','MaxDD'],['sortino','Sortino']];
  $('stratTable').innerHTML=`<table><thead><tr>${cols.map(([k,l])=>`<th data-c="${k}">${l}${arrow(k)}</th>`).join('')}</tr></thead><tbody>${s.map(r=>`<tr>
    <td>${r.strategy||'—'}</td><td>${r.trades}</td><td>${pct(r.win_rate)}</td>
    <td class="${cls(r.pnl)}">$${fmt(r.pnl)}</td><td class="neg">$${fmt(r.max_drawdown)}</td><td>${fmt(r.sortino)}</td>
  </tr>`).join('')}</tbody></table>`;
  $('stratTable').querySelectorAll('th').forEach(th=>th.onclick=()=>{const c=th.dataset.c;if(sortCol===c)sortAsc=!sortAsc;else{sortCol=c;sortAsc=false}renderStratTable()});
}

async function loadEquity(){
  const d=await F('/api/equity?mode='+mode+'&points=300');
  const eq=d.equity||[];
  const labels=eq.map(p=>new Date(p.t).toLocaleDateString('en-US',{month:'short',day:'numeric'}));
  const data=eq.map(p=>p.b);
  if(chart)chart.destroy();
  chart=new Chart($('equityChart'),{type:'line',data:{labels,datasets:[{label:'Balance',data,borderColor:'#58a6ff',backgroundColor:'rgba(88,166,255,.1)',fill:true,tension:.3,pointRadius:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#8b949e',maxTicksLimit:8},grid:{color:'#21262d'}},y:{ticks:{color:'#8b949e'},grid:{color:'#21262d'}}}}});
}

async function loadSignals(){
  const d=await F('/api/signals?limit=50');
  const sigs=d.signals||[];
  if(!sigs.length){$('signalFeed').innerHTML='<span class="loading">No signals yet</span>';return}
  $('signalFeed').innerHTML=sigs.map(s=>`<div class="sig">
    <span class="ts">${ts(s.timestamp)}</span>
    <span class="dir ${s.direction}">${s.direction}</span>
    <span>${s.strategy_name||'—'}</span>
    <span class="conf">${(s.confidence*100).toFixed(0)}%</span>
    <span>$${fmt(s.price)}</span>
  </div>`).join('');
}

async function loadStrategies(){/* merged into stats view */}

refresh();
setInterval(refresh,30000);
</script>
</body>
</html>
