<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title>Trading Dashboard</title>
<link rel="icon" href="/dash/favicon.ico">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
:root{--bg:#0d1117;--surface:#161b22;--border:#21262d;--border2:#30363d;--text:#c9d1d9;--text2:#8b949e;--text3:#484f58;--white:#f0f6fc;--blue:#58a6ff;--green:#3fb950;--red:#f85149;--orange:#d29922}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-size:13px;padding:12px 16px;max-width:1400px;margin:0 auto}
.hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.hdr h1{font-size:1.1rem;color:var(--white);font-weight:700;letter-spacing:-.3px}
.hdr-right{display:flex;align-items:center;gap:14px}
.health{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text2)}
.dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.dot-g{background:var(--green)}.dot-r{background:var(--red)}.dot-x{background:var(--text3)}
.refresh{font-size:10px;color:var(--text3)}
.tabs{display:flex;gap:0;margin-bottom:12px;border-bottom:1px solid var(--border2)}
.tab{padding:7px 18px;cursor:pointer;font-weight:600;font-size:12px;color:var(--text2);border-bottom:2px solid transparent;transition:all .15s}
.tab:hover{color:var(--text)}.tab.on{color:var(--blue);border-bottom-color:var(--blue)}
.pane{display:none}.pane.on{display:block}
.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px}
.card-l{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.6px;margin-bottom:2px}
.card-v{font-size:1.25rem;font-weight:700;color:var(--white)}
.g{color:var(--green)}.r{color:var(--red)}
.chart-box{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:12px;height:200px;position:relative}
.tbl-wrap{overflow-x:auto;border-radius:8px;border:1px solid var(--border);margin-bottom:12px;max-height:340px;overflow-y:auto}
table{width:100%;border-collapse:collapse;background:var(--surface)}
th,td{padding:5px 10px;text-align:left;font-size:12px;border-bottom:1px solid var(--border);white-space:nowrap}
th{background:var(--bg);color:var(--text2);cursor:pointer;user-select:none;position:sticky;top:0;z-index:1;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.4px}
th:hover{color:var(--text)}
.badge{display:inline-block;padding:1px 7px;border-radius:10px;font-size:10px;font-weight:600}
.b-a{background:#23812e22;color:var(--green)}.b-s{background:#484f5822;color:var(--text3)}.b-l{background:#58a6ff22;color:var(--blue)}
.pnl-section{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px}
.pnl-tabs{display:flex;gap:0;margin-bottom:12px;border-bottom:1px solid var(--border2)}
.pnl-tab{padding:6px 16px;cursor:pointer;font-weight:600;font-size:11px;color:var(--text2);border-bottom:2px solid transparent;transition:all .15s;text-transform:uppercase;letter-spacing:.5px}
.pnl-tab:hover{color:var(--text)}.pnl-tab.on{color:var(--blue);border-bottom-color:var(--blue)}
.pnl-display{display:flex;align-items:center;gap:12px}
.pnl-amount{font-size:1.75rem;font-weight:700;color:var(--white)}
.pnl-percent{font-size:1rem;font-weight:600;padding:3px 8px;border-radius:6px}
.feed{display:flex;flex-direction:column;gap:4px;max-height:500px;overflow-y:auto}
.fi{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 10px}
.fi-icon{width:22px;height:22px;border-radius:50%;flex-shrink:0}
.fi-body{flex:1;min-width:0}
.fi-title{font-size:11px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fi-sub{font-size:10px;color:var(--text2);margin-top:1px}
.fi-amt{font-size:12px;font-weight:600;white-space:nowrap;margin-left:8px}
.fi-tag{font-size:9px;padding:2px 6px;border-radius:8px;white-space:nowrap;margin-left:6px;font-weight:600}
.t-claim{background:#1a3a2a;color:var(--green)}.t-buy{background:#1c2a3a;color:var(--blue)}.t-other{background:#2d2a1a;color:var(--orange)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.section-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;font-weight:600}
.tracked-row{background:rgba(88,166,255,0.04)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WHALE TAB PREMIUM STYLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.whale-hero{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
.whale-hero-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 18px;position:relative;overflow:hidden;transition:transform .2s,box-shadow .2s}
.whale-hero-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.3)}
.whale-hero-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.whale-hero-card:nth-child(1)::before{background:linear-gradient(90deg,#58a6ff,#388bfd)}
.whale-hero-card:nth-child(2)::before{background:linear-gradient(90deg,#bc8cff,#8957e5)}
.whale-hero-card:nth-child(3)::before{background:linear-gradient(90deg,#3fb950,#238636)}
.whale-hero-card:nth-child(4)::before{background:linear-gradient(90deg,#f0883e,#d29922)}
.whc-label{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.whc-value{font-size:1.6rem;font-weight:800;color:var(--white);letter-spacing:-.5px}
.whc-trend{font-size:10px;font-weight:600;margin-top:4px;display:flex;align-items:center;gap:4px}
/* Whale Cards Grid */
.whale-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;margin-bottom:16px}
.whale-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:14px;transition:all .2s;position:relative;overflow:hidden}
.whale-card:hover{border-color:var(--border2);box-shadow:0 4px 16px rgba(0,0,0,.25)}
.whale-card-head{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.whale-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#fff;flex-shrink:0;text-transform:uppercase}
.whale-name{font-weight:700;color:var(--white);font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.whale-rank{font-size:10px;color:var(--text2);font-weight:600}
.whale-badge{font-size:9px;padding:2px 8px;border-radius:10px;font-weight:700;margin-left:auto;white-space:nowrap}
.whale-badge.hot{background:rgba(63,185,80,.15);color:var(--green);border:1px solid rgba(63,185,80,.25)}
.whale-badge.cold{background:rgba(248,81,73,.15);color:var(--red);border:1px solid rgba(248,81,73,.25)}
.whale-badge.neutral{background:rgba(139,148,158,.1);color:var(--text2);border:1px solid rgba(139,148,158,.2)}
.whale-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.whale-stat{display:flex;flex-direction:column;gap:2px}
.whale-stat-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px}
.whale-stat-val{font-size:13px;font-weight:700}

/* CSS Win Rate Ring */
.whale-wr-ring{width:40px;height:40px;border-radius:50%;position:relative;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.whale-wr-ring::before{content:'';position:absolute;inset:3px;border-radius:50%;background:var(--surface)}
.whale-wr-text{font-size:9px;font-weight:700;position:relative;z-index:1}

/* PnL Bar */
.whale-pnl-bar{height:4px;border-radius:2px;background:var(--border);margin-top:6px;overflow:hidden}
.whale-pnl-fill{height:100%;border-radius:2px;transition:width .5s ease}

/* Timeline Feed */
.whale-timeline{position:relative;padding-left:20px;display:flex;flex-direction:column;gap:0;max-height:500px;overflow-y:auto}
.whale-timeline::before{content:'';position:absolute;left:7px;top:0;bottom:0;width:2px;background:var(--border)}
.wt-item{position:relative;padding:10px 12px 10px 16px;border:1px solid var(--border);background:var(--surface);border-radius:10px;margin-bottom:6px;transition:all .2s;animation:wtSlide .4s ease-out both}
.wt-item:hover{border-color:var(--border2);background:#1c2128}
.wt-item::before{content:'';position:absolute;left:-17px;top:16px;width:10px;height:10px;border-radius:50%;border:2px solid var(--border);background:var(--bg);z-index:1}
.wt-item.wt-win::before{border-color:var(--green);background:var(--green);box-shadow:0 0 6px rgba(63,185,80,.4)}
.wt-item.wt-loss::before{border-color:var(--red);background:var(--red);box-shadow:0 0 6px rgba(248,81,73,.4)}
.wt-item.wt-pending::before{border-color:var(--text3);background:var(--text3)}
@keyframes wtSlide{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
.wt-head{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.wt-market{font-size:12px;color:var(--text);font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.wt-whale-tag{font-size:9px;padding:2px 7px;border-radius:8px;background:rgba(88,166,255,.1);color:var(--blue);font-weight:600;white-space:nowrap}
.wt-meta{display:flex;align-items:center;gap:12px;font-size:10px;color:var(--text2)}
.wt-pnl{font-weight:700;font-size:12px;margin-left:auto}
.wt-time{font-size:10px;color:var(--text3)}

/* Leaderboard Table Premium */
.whale-lb-wrap{border-radius:12px;border:1px solid var(--border);overflow:hidden;margin-bottom:16px}
.whale-lb-wrap table{background:var(--surface)}
.whale-lb-wrap tbody tr{transition:all .15s}
.whale-lb-wrap tbody tr:nth-child(even){background:rgba(22,27,34,.6)}
.whale-lb-wrap tbody tr:hover{background:rgba(88,166,255,.06)}
.whale-lb-wrap .pnl-bar-cell{position:relative}
.whale-lb-wrap .pnl-bar-bg{position:absolute;top:2px;bottom:2px;left:0;border-radius:3px;opacity:.15;z-index:0}
.whale-lb-wrap .pnl-bar-text{position:relative;z-index:1}
.btn-track{padding:3px 10px;border-radius:6px;font-size:10px;font-weight:600;border:1px solid var(--border2);background:transparent;color:var(--text2);cursor:pointer;transition:all .15s}
.btn-track:hover{background:rgba(88,166,255,.1);color:var(--blue);border-color:var(--blue)}

/* Sort Controls */
.whale-sort-bar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.whale-sort-btn{padding:4px 12px;border-radius:6px;font-size:10px;font-weight:600;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;transition:all .15s}
.whale-sort-btn:hover,.whale-sort-btn.active{background:rgba(88,166,255,.1);color:var(--blue);border-color:var(--blue)}

/* Two Column Layout */
.whale-columns{display:grid;grid-template-columns:3fr 2fr;gap:16px;margin-bottom:16px}

@media(max-width:768px){
  .cards{grid-template-columns:repeat(2,1fr)}.row{grid-template-columns:1fr}.chart-box{height:180px}
  .whale-hero{grid-template-columns:repeat(2,1fr)}
  .whale-grid{grid-template-columns:1fr}
  .whale-columns{grid-template-columns:1fr}
  .whc-value{font-size:1.2rem}
}
@media(max-width:480px){body{padding:8px}.card-v{font-size:1rem}.tabs{overflow-x:auto}
  .whale-hero{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>
<div id="stage-banner" style="background:linear-gradient(90deg,#d29922,#f0883e);color:#0d1117;text-align:center;padding:8px 16px;border-radius:8px;margin-bottom:10px;font-weight:700;font-size:13px;display:none">
  ‚ö†Ô∏è STAGE 0 ‚Äî PAPER ONLY ‚Äî No live orders permitted
</div>
<div class="hdr">
  <h1>üìä Trading Dashboard</h1>
  <div class="hdr-right">
    <div class="health"><span class="dot dot-x" id="h-sig"></span>Signals</div>
    <div class="health"><span class="dot dot-x" id="h-pap"></span>Paper</div>
    <div class="health"><span class="dot dot-x" id="h-liv"></span>Live</div>
    <div class="health"><span class="dot dot-x" id="h-api"></span>API</div>
    <span class="refresh" id="ref">‚Äî</span>
  </div>
</div>

<div class="tabs">
  <div class="tab on" onclick="sw('whale')">üêã Whale Copy</div>
  <div class="tab" onclick="sw('paper')">üìä Paper Trading</div>
  <div class="tab" onclick="sw('live')">üî¥ Live Trading</div>
</div>

<!-- Paper Trading (V2 EV-Gated) -->
<div class="pane" id="p-paper">
  <div class="cards" id="v2c"></div>
  <div class="section-label">EV Gate Metrics</div>
  <div class="cards" id="v2ev"></div>
  <div class="section-label" style="margin-top:12px">Strategy Leaderboard</div>
  <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
    <select id="v2-sort" onchange="refreshV2Leaderboard()" style="background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:4px 8px;font-size:12px">
      <option value="total_pnl">Sort: Total PnL</option><option value="avg_pnl">Avg PnL</option>
      <option value="edge_lb">Edge LB</option><option value="p10_win_rate">P10 Win%</option>
      <option value="take_rate">Take Rate</option><option value="calibration_gap">Calib Gap</option>
    </select>
    <label style="font-size:12px;color:var(--text2);cursor:pointer"><input type="checkbox" id="v2-small" onchange="refreshV2Leaderboard()"> Show small samples</label>
  </div>
  <div class="tbl-wrap"><table id="v2-lb"><thead><tr>
    <th>Strategy</th><th>Trades</th><th>Win%</th><th title="Bayesian 10th percentile win rate">P10 Win%</th><th>PnL</th><th>Avg PnL</th><th>Take Rate</th><th title="Lower bound edge">Edge LB</th><th>Calib Gap</th><th>Badges</th>
  </tr></thead><tbody></tbody></table></div>
  <div id="v2-detail" style="display:none;margin-bottom:12px"></div>
</div>

<!-- Whale Copy Trading -->
<div class="pane on" id="p-whale">
  <div class="whale-hero" id="whale-cards"></div>

  <!-- Trade Summary Bar -->
  <div id="whale-summary-bar" style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:8px 14px;margin-bottom:12px;display:flex;align-items:center;gap:16px;font-size:12px;flex-wrap:wrap">
    <span style="color:var(--text2);font-weight:600">Copy Performance:</span>
    <span id="ws-wins" style="color:var(--green);font-weight:700">‚ÄîW</span>
    <span id="ws-losses" style="color:var(--red);font-weight:700">‚ÄîL</span>
    <span id="ws-pending" style="color:var(--text3);font-weight:600">‚Äî pending</span>
    <span style="color:var(--border2)">|</span>
    <span id="ws-pnl" style="font-weight:800;font-size:13px">‚Äî</span>
  </div>

  <div class="whale-columns">
    <div>
      <div class="section-label" style="margin-bottom:8px">‚ö° Recent Copy Trades</div>
      <div class="whale-timeline" id="whale-timeline"></div>
    </div>
    <div>
      <div class="section-label" style="margin-bottom:8px">üêã Tracked Whales</div>
      <div class="whale-sort-bar">
        <button class="whale-sort-btn active" onclick="sortWhaleCards('roi')">By ROI</button>
        <button class="whale-sort-btn" onclick="sortWhaleCards('pnl')">By PnL</button>
        <button class="whale-sort-btn" onclick="sortWhaleCards('wr')">By Win Rate</button>
        <button class="whale-sort-btn" onclick="sortWhaleCards('copies')">By Copies</button>
      </div>
      <div class="whale-lb-wrap" style="max-height:500px;overflow-y:auto"><table id="whale-tracked-table"><thead><tr>
        <th></th><th>Name</th><th>ROI</th><th>PnL</th><th>WR</th><th>Copies</th><th>Status</th>
      </tr></thead><tbody></tbody></table></div>
      <div class="whale-grid" id="whale-tracked-grid" style="display:none"></div>
    </div>
  </div>

  <div style="margin-top:4px;margin-bottom:8px;cursor:pointer;user-select:none" onclick="document.getElementById('whale-all-section').style.display=document.getElementById('whale-all-section').style.display==='none'?'block':'none';this.querySelector('.chevron').textContent=document.getElementById('whale-all-section').style.display==='none'?'‚ñ∂':'‚ñº'">
    <span class="section-label">üèÜ All Whales Leaderboard</span> <span class="chevron" style="font-size:10px;color:var(--text3)">‚ñ∂</span>
  </div>
  <div id="whale-all-section" style="display:none">
    <div class="whale-lb-wrap"><table id="whale-all"><thead><tr>
      <th>Rank</th><th>Name</th><th>Weekly PnL</th><th>Volume</th><th>Tracked</th><th></th>
    </tr></thead><tbody></tbody></table></div>
  </div>

  <!-- Hidden legacy tables for loadWhale compat -->
  <table id="whale-lb" style="display:none"><tbody></tbody></table>
  <table id="whale-trades" style="display:none"><tbody></tbody></table>
</div>

<!-- Live Trading -->
<div class="pane" id="p-live">
  <div class="cards" id="lc"></div>
  <div class="section-label">P&L Performance</div>
  <div class="pnl-section">
    <div class="pnl-tabs">
      <div class="pnl-tab on" onclick="setPnlPeriod('1d')">1D</div>
      <div class="pnl-tab" onclick="setPnlPeriod('1w')">1W</div>
      <div class="pnl-tab" onclick="setPnlPeriod('1m')">1M</div>
      <div class="pnl-tab" onclick="setPnlPeriod('all')">ALL</div>
    </div>
    <div class="pnl-display">
      <div class="pnl-amount" id="pnl-amount">‚Äî</div>
      <div class="pnl-percent" id="pnl-percent">‚Äî</div>
    </div>
  </div>
  <div class="chart-box" style="height:280px;margin-bottom:16px;"><canvas id="pnlChart"></canvas></div>
  <div class="section-label">Recent Activity</div>
  <div class="feed" id="feed"></div>
</div>

<script>
const API='https://api.peytoncampbell.ca',KEY='65bc4d4ad01756a528c74480067c330da9461584b3b7347e',H={headers:{'X-API-Key':KEY}};
let pnlChart,currentPnlPeriod='1d';
async function q(p){try{const r=await fetch(API+p,H);if(!r.ok)throw r;return r.json()}catch{return null}}
function sw(t){const tabs=['whale','paper','live'];document.querySelectorAll('.tab').forEach((e,i)=>e.classList.toggle('on',i===tabs.indexOf(t)));tabs.forEach(id=>document.getElementById('p-'+id).classList.toggle('on',id===t))}
const f2=(v,d=2)=>v==null?'‚Äî':Number(v).toFixed(d);
const f$=v=>v==null?'‚Äî':'$'+f2(v);
const fP=v=>v==null?'‚Äî':f2(v,1)+'%';
const pc=v=>v>=0?'g':'r';

function mkPnlChart(ctx,data){
  const pts=(data||[]).map(d=>({x:new Date(d.timestamp),y:d.cumulative_pnl!=null?d.cumulative_pnl:d.pnl}));
  const color=pts.length&&pts[pts.length-1].y>=0?'#3fb950':'#f85149';
  return new Chart(ctx,{type:'line',data:{datasets:[{data:pts,borderColor:color,backgroundColor:color+'15',fill:true,pointRadius:1,tension:.2,borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,animation:{duration:300},interaction:{intersect:false,mode:'index'},plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>'$'+c.parsed.y.toFixed(2)}}},scales:{x:{type:'time',grid:{color:'#161b22'},ticks:{color:'var(--text3)',maxTicksLimit:8,font:{size:10}}},y:{grid:{color:'#161b22'},ticks:{color:'var(--text3)',font:{size:10},callback:v=>'$'+v.toFixed(2)}}}}});
}

async function setPnlPeriod(period){
  currentPnlPeriod=period;
  document.querySelectorAll('.pnl-tab').forEach(t=>t.classList.remove('on'));
  document.querySelector(`[onclick="setPnlPeriod('${period}')"]`).classList.add('on');
  await refreshPnl();
}

async function refreshPnl(){
  const pnl=await q(`/api/pnl?period=${currentPnlPeriod}`);
  if(pnl){
    const amt=document.getElementById('pnl-amount');
    const pct=document.getElementById('pnl-percent');
    amt.textContent=f$(pnl.pnl);
    amt.className=`pnl-amount ${pc(pnl.pnl)}`;
    if(pnl.pnl_pct!=null){
      pct.textContent=`(${pnl.pnl_pct>=0?'+':''}${fP(pnl.pnl_pct)})`;
      pct.className=`pnl-percent ${pc(pnl.pnl_pct)}`;
      pct.style.backgroundColor=pnl.pnl_pct>=0?'rgba(63,185,80,0.15)':'rgba(248,81,73,0.15)';
    }
    if(!pnlChart)pnlChart=mkPnlChart(document.getElementById('pnlChart'),pnl.equity_curve);
    else{
      const pts=(pnl.equity_curve||[]).map(d=>({x:new Date(d.timestamp),y:d.cumulative_pnl!=null?d.cumulative_pnl:d.pnl}));
      const color=pts.length&&pts[pts.length-1].y>=0?'#3fb950':'#f85149';
      pnlChart.data.datasets[0].data=pts;pnlChart.data.datasets[0].borderColor=color;pnlChart.data.datasets[0].backgroundColor=color+'15';pnlChart.update('none');
    }
  }
}

function v2Badge(s){
  if(s.disable_recommendation)return'<span class="badge" style="background:#f8514922;color:var(--red)">‚õî Disable</span>';
  if(s.kill_candidate)return'<span class="badge" style="background:#f8514922;color:var(--red)">üíÄ Kill</span>';
  if(s.watchlist)return'<span class="badge" style="background:#3fb95022;color:var(--green)">‚≠ê Watch</span>';
  if(s.small_sample)return'<span class="badge" style="background:#484f5822;color:var(--text3)">üìä Small</span>';
  return'‚Äî';
}

async function refreshV2Leaderboard(){
  const sort=document.getElementById('v2-sort')?.value||'total_pnl';
  const mt=document.getElementById('v2-small')?.checked?3:20;
  const d=await q(`/api/paper_v2_strategies?min_trades=${mt}&sort=${sort}`);
  if(!d||!d.strategies)return;
  document.querySelector('#v2-lb tbody').innerHTML=d.strategies.map(s=>
    `<tr style="cursor:pointer" onclick="showV2Detail('${s.strategy_name}')">
      <td style="color:var(--blue);font-weight:600">${s.strategy_name}</td>
      <td>${s.trades_resolved}</td><td>${fP(s.win_rate*100)}</td><td>${fP(s.p10_win_rate*100)}</td>
      <td class="${pc(s.total_pnl)}">${f$(s.total_pnl)}</td><td class="${pc(s.avg_pnl)}">${f$(s.avg_pnl)}</td>
      <td>${fP(s.take_rate*100)}</td><td class="${pc(s.edge_lb)}">${f2(s.edge_lb,4)}</td>
      <td class="${pc(s.calibration_gap)}">${f2(s.calibration_gap,4)}</td><td>${v2Badge(s)}</td></tr>`
  ).join('');
}

async function showV2Detail(name){
  const el=document.getElementById('v2-detail');
  if(el.dataset.open===name){el.style.display='none';el.dataset.open='';return;}
  const d=await q('/api/paper_v2_strategy?name='+encodeURIComponent(name));
  if(!d)return;
  const sm=d.summary||{};
  let h=`<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;margin-top:8px">
    <div style="font-weight:700;color:var(--white);margin-bottom:8px;font-size:14px">${name} ‚Äî Detail</div>
    <div style="display:flex;gap:16px;margin-bottom:8px;font-size:12px;color:var(--text2)">
      <span>Trades: ${sm.total||0}</span><span>PnL: <b class="${pc(sm.total_pnl)}">${f$(sm.total_pnl)}</b></span>
      <span>P10 Win%: <b>${sm.p10_win_rate!=null?fP(sm.p10_win_rate*100):'‚Äî'}</b></span>
      <span>Edge LB: <b class="${pc(sm.edge_lb)}">${sm.edge_lb!=null?f2(sm.edge_lb,4):'‚Äî'}</b></span>
    </div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">`;
  if(d.by_price_bucket?.length){
    h+=`<div><div class="section-label">By Price Bucket</div><div class="tbl-wrap" style="max-height:200px"><table><thead><tr><th>Bucket</th><th>#</th><th>Wins</th><th>PnL</th></tr></thead><tbody>`;
    d.by_price_bucket.forEach(r=>{h+=`<tr><td>${r.price_bucket||'‚Äî'}</td><td>${r.trades}</td><td>${r.wins}</td><td class="${pc(r.pnl)}">${f$(r.pnl)}</td></tr>`});
    h+=`</tbody></table></div></div>`;
  }
  if(d.by_tod_bucket?.length){
    h+=`<div><div class="section-label">By Time of Day</div><div class="tbl-wrap" style="max-height:200px"><table><thead><tr><th>TOD</th><th>#</th><th>Wins</th><th>PnL</th></tr></thead><tbody>`;
    d.by_tod_bucket.forEach(r=>{h+=`<tr><td>${r.tod_bucket||'‚Äî'}</td><td>${r.trades}</td><td>${r.wins}</td><td class="${pc(r.pnl)}">${f$(r.pnl)}</td></tr>`});
    h+=`</tbody></table></div></div>`;
  }
  h+=`</div>`;
  if(d.ev_decisions?.length){
    h+=`<div class="section-label" style="margin-top:8px">EV Decisions</div><div style="display:flex;gap:8px;flex-wrap:wrap">`;
    d.ev_decisions.forEach(r=>{h+=`<span class="badge ${r.decision==='TAKE'?'b-a':'b-s'}" style="font-size:11px;padding:3px 10px">${r.decision}: ${r.cnt}</span>`});
    h+=`</div>`;
  }
  if(d.recent_trades?.length){
    h+=`<div class="section-label" style="margin-top:8px">Recent Trades (last 10)</div><div class="tbl-wrap" style="max-height:240px"><table><thead><tr><th>Time</th><th>Side</th><th>Price</th><th>Result</th><th>PnL</th><th>EV Est</th></tr></thead><tbody>`;
    d.recent_trades.slice(0,10).forEach(r=>{
      const t=r.timestamp?new Date(r.timestamp).toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}):'‚Äî';
      h+=`<tr><td>${t}</td><td>${r.side||'‚Äî'}</td><td>${f$(r.buy_price)}</td><td class="${r.outcome==='WIN'?'g':r.outcome==='LOSS'?'r':''}">${r.outcome||'PENDING'}</td><td class="${pc(r.pnl)}">${r.pnl!=null?f$(r.pnl):'‚Äî'}</td><td>${r.ev_est!=null?f2(r.ev_est,4):'‚Äî'}</td></tr>`;
    });
    h+=`</tbody></table></div>`;
  }
  h+=`</div>`;
  el.innerHTML=h;el.style.display='block';el.dataset.open=name;
}

async function refresh(){
  const[health,pos]=await Promise.all([q('/api/health'),q('/api/positions')]);
  if(health){
    const now=Date.now();
    const chk=(id,o)=>{const ts=o&&(o.last_heartbeat||o.ts||o);document.getElementById(id).className='dot '+(ts&&(now-new Date(ts).getTime())<120000?'dot-g':'dot-r')};
    chk('h-sig',health.signal_engine);chk('h-pap',health.paper_trader);chk('h-liv',health.live_trader);
    document.getElementById('h-api').className='dot dot-g';
  }
  if(pos){
    const s=pos.summary||{};
    const dailyPnl=await q('/api/pnl?period=1d');
    const dd=dailyPnl?`<span class="${pc(dailyPnl.pnl)}">${dailyPnl.pnl>=0?'+':''}${f$(dailyPnl.pnl)} (${dailyPnl.pnl_pct>=0?'+':''}${fP(dailyPnl.pnl_pct)})</span>`:'‚Äî';
    document.getElementById('lc').innerHTML=`
      <div class="card"><div class="card-l">Portfolio</div><div class="card-v">${s.balance!=null?f$(s.balance):'‚Äî'}</div></div>
      <div class="card"><div class="card-l">Cash</div><div class="card-v">${s.cash_balance!=null?f$(s.cash_balance):'‚Äî'}</div></div>
      <div class="card"><div class="card-l">Total Redeemed</div><div class="card-v g">${s.total_redeemed!=null?f$(s.total_redeemed):'‚Äî'}</div></div>
      <div class="card"><div class="card-l">Daily Change</div><div class="card-v">${dd}</div></div>`;
    const now=Date.now()/1000;
    document.getElementById('feed').innerHTML=(pos.activity||[]).map(a=>{
      const ic=a.icon?`<img class="fi-icon" src="${a.icon}">`:'';
      if(a.type==='REDEEM')return`<div class="fi">${ic}<div class="fi-body"><div class="fi-title">${a.title}</div><div class="fi-sub">Claimed</div></div><div class="fi-amt g">+${f$(a.usdc)}</div><div class="fi-tag t-claim">Claimed</div></div>`;
      if(a.type==='TRADE'&&a.side==='BUY'){const m=Math.round((now-a.timestamp)/60);const ago=m<60?m+'m':m<1440?Math.round(m/60)+'h':Math.round(m/1440)+'d';return`<div class="fi">${ic}<div class="fi-body"><div class="fi-title">${a.title}</div><div class="fi-sub">Bought ${Math.round(a.size)} ${a.outcome} at ${Math.round(a.price*100)}¬¢</div></div><div class="fi-amt" style="color:var(--text2)">-${f$(a.usdc)}</div><div class="fi-tag t-buy">${ago} ago</div></div>`}
      return`<div class="fi">${ic}<div class="fi-body"><div class="fi-title">${a.title}</div><div class="fi-sub">${a.type} ${a.outcome||''}</div></div><div class="fi-amt">${f$(a.usdc)}</div><div class="fi-tag t-other">${a.type}</div></div>`;
    }).join('');
  }
  if(document.querySelector('#p-live.on'))await refreshPnl();
  const stage=await q('/api/stage');
  document.getElementById('stage-banner').style.display=(stage&&stage.trading_stage==='STAGE_0')?'block':'none';
  const v2=await q('/api/paper_v2_stats');
  if(v2&&!v2.error){
    document.getElementById('v2c').innerHTML=`
      <div class="card"><div class="card-l">Total P&L</div><div class="card-v ${pc(v2.total_pnl)}">${f$(v2.total_pnl)}</div></div>
      <div class="card"><div class="card-l">Win Rate</div><div class="card-v">${fP(v2.win_rate*100)}</div></div>
      <div class="card"><div class="card-l">Trades Taken</div><div class="card-v">${v2.trades_taken}</div></div>
      <div class="card"><div class="card-l">Max Drawdown</div><div class="card-v r">${f$(v2.max_drawdown)}</div></div>`;
    document.getElementById('v2ev').innerHTML=`
      <div class="card"><div class="card-l">Take Rate</div><div class="card-v">${fP(v2.take_rate*100)}</div></div>
      <div class="card"><div class="card-l">Trades Skipped</div><div class="card-v">${v2.trades_skipped}</div></div>
      <div class="card"><div class="card-l">Avg Predicted EV</div><div class="card-v">${f2(v2.avg_predicted_ev,4)}</div></div>
      <div class="card"><div class="card-l">Calibration Error</div><div class="card-v">${f2(v2.calibration_error,4)}</div></div>`;
  }
  await refreshV2Leaderboard();
  document.getElementById('ref').textContent=new Date().toLocaleTimeString()+' ¬∑ 60s';
}

let whaleDataCache=null,whaleSortMode='roi';
const whaleColors=['#58a6ff','#bc8cff','#3fb950','#f0883e','#f85149','#8957e5','#d29922','#39d353','#da3633','#79c0ff'];
function whaleInitials(name){if(!name)return'?';const clean=name.replace(/^0x/,'');return clean.slice(0,2).toUpperCase()}
function whaleColor(name){let h=0;for(let i=0;i<(name||'').length;i++)h=name.charCodeAt(i)+((h<<5)-h);return whaleColors[Math.abs(h)%whaleColors.length]}
function wrRingStyle(wr){const deg=Math.round(wr*360);const c=wr>=.7?'var(--green)':wr>=.4?'var(--orange)':'var(--red)';return`background:conic-gradient(${c} ${deg}deg, var(--border) ${deg}deg)`}
function whaleStatus(w){if(!w.copies||w.copies<1)return{cls:'neutral',text:'üìä New'};if(w.win_rate>=.7&&w.our_pnl>0)return{cls:'hot',text:'üü¢ Hot'};if(w.win_rate<.4||w.our_pnl<0)return{cls:'cold',text:'üî¥ Cold'};return{cls:'neutral',text:'‚ö™ Neutral'}}
function sortWhaleCards(mode){
  whaleSortMode=mode;
  document.querySelectorAll('.whale-sort-btn').forEach(b=>b.classList.toggle('active',b.textContent.toLowerCase().includes(mode==='roi'?'roi':mode==='pnl'?'pnl':mode==='wr'?'win':mode)));
  if(whaleDataCache)renderWhaleCards(whaleDataCache);
}

function renderWhaleCards(tracked){
  const sorted=[...tracked].sort((a,b)=>{
    if(whaleSortMode==='wr')return(b.win_rate||0)-(a.win_rate||0);
    if(whaleSortMode==='copies')return(b.copies||0)-(a.copies||0);
    if(whaleSortMode==='pnl')return(b.our_pnl||0)-(a.our_pnl||0);
    return(b.roi||0)-(a.roi||0);
  });
  const tbody=document.querySelector('#whale-tracked-table tbody');
  if(!tbody)return;
  tbody.innerHTML=sorted.map(w=>{
    const name=w.name||w.address?.slice(0,8)||'?';
    const st=whaleStatus(w);
    const wr=w.copies>0?w.win_rate:0;
    const wrColor=wr>=.6?'var(--green)':wr>=.4?'var(--orange)':'var(--red)';
    const roi=w.roi||0;
    const roiColor=roi>0?'var(--green)':roi<0?'var(--red)':'var(--text3)';
    return`<tr>
      <td><div class="whale-avatar" style="background:${whaleColor(name)};width:24px;height:24px;font-size:9px">${whaleInitials(name)}</div></td>
      <td style="color:var(--white);font-weight:600;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${name}</td>
      <td style="color:${roiColor};font-weight:800">${w.copies?((roi>=0?'+':'')+roi.toFixed(1)+'%'):'‚Äî'}</td>
      <td class="${pc(w.our_pnl)}" style="font-weight:700">${f$(w.our_pnl)}</td>
      <td style="color:${w.copies?wrColor:'var(--text3)'};font-weight:600">${w.copies?Math.round(wr*100)+'%':'‚Äî'}</td>
      <td style="color:var(--white)">${w.copies||0}</td>
      <td><span class="whale-badge ${st.cls}">${st.text}</span></td>
    </tr>`}).join('');
}

function renderWhaleTimeline(trades,whales){
  const nameMap={};(whales||[]).forEach(w=>{if(w.address)nameMap[w.address.toLowerCase()]=w.name||w.address.slice(0,8)});
  document.getElementById('whale-timeline').innerHTML=(trades||[]).slice(0,20).map((t,i)=>{
    const cls=t.status==='WIN'?'wt-win':t.status==='LOSS'?'wt-loss':'wt-pending';
    const ts=t.timestamp?new Date(t.timestamp).toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}):'‚Äî';
    const wname=nameMap[(t.whale_address||'').toLowerCase()]||t.whale_address?.slice(0,8)||'?';
    const pnlStr=t.pnl!=null?`<span class="wt-pnl ${pc(t.pnl)}">${t.pnl>=0?'+':''}${f$(t.pnl)}</span>`:'<span class="wt-pnl" style="color:var(--text3)">pending</span>';
    return`<div class="wt-item ${cls}" style="animation-delay:${i*40}ms">
      <div class="wt-head">
        <span class="wt-market">üìä ${t.market_title||'Unknown Market'}</span>
        <span class="wt-whale-tag">üêã ${wname}</span>
      </div>
      <div class="wt-meta">
        <span class="wt-time">${ts}</span>
        <span>${t.side||'BUY'} at ${f2(t.our_price,2)}¬¢</span>
        <span>${f$(t.our_size_usd)}</span>
        ${pnlStr}
      </div>
    </div>`}).join('');
}

async function loadWhale(){
  const d=await q('/api/whales');
  if(!d)return;
  const s=d.summary||{};
  const whales=d.whales||[];
  const allWithTrades=whales.filter(w=>w.tracked||w.copies>0);
  whaleDataCache=allWithTrades;

  // Hero cards
  const totalPnl=s.total_copy_pnl||0;
  const activeWhales=allWithTrades.filter(w=>w.copies>0);
  const bestW=allWithTrades.filter(w=>w.copies>0).reduce((b,w)=>(!b||(w.roi||0)>(b.roi||0))?w:b,null);
  const bestName=bestW?(bestW.name||(bestW.address?bestW.address.slice(0,6)+'‚Ä¶'+bestW.address.slice(-4):null)||'‚Äî'):'‚Äî';
  document.getElementById('whale-cards').innerHTML=`
    <div class="whale-hero-card">
      <div class="whc-label">üêã Whales Tracked</div>
      <div class="whc-value">${allWithTrades.length}</div>
      <div class="whc-trend" style="color:var(--text3)">${activeWhales.length} with trades</div>
    </div>
    <div class="whale-hero-card">
      <div class="whc-label">üìã Paper Trades</div>
      <div class="whc-value">${s.paper_trades||0}</div>
      <div class="whc-trend" style="color:var(--text3)">${f$(s.total_exposure)} exposure</div>
    </div>
    <div class="whale-hero-card">
      <div class="whc-label">üí∞ Total Copy P&L</div>
      <div class="whc-value ${pc(totalPnl)}">${totalPnl>=0?'+':''}${f$(totalPnl)}</div>
      <div class="whc-trend ${pc(totalPnl)}">${totalPnl>=0?'‚ñ≤ Profitable':'‚ñº In drawdown'}</div>
    </div>
    <div class="whale-hero-card">
      <div class="whc-label">üèÜ Top Performer</div>
      <div class="whc-value" style="font-size:1.1rem">${bestName}</div>
      <div class="whc-trend" style="color:var(--green)">${bestW?((bestW.roi||0)>=0?'+':'')+(bestW.roi||0).toFixed(1)+'% ROI ¬∑ '+f$(bestW.our_pnl):'‚Äî'}</div>
    </div>`;
  // Summary bar
  const wins=s.total_wins||0;
  const losses=s.total_losses||0;
  const pending=s.total_pending||0;
  document.getElementById('ws-wins').textContent=wins+'W';
  document.getElementById('ws-losses').textContent=losses+'L';
  document.getElementById('ws-pending').textContent=pending+' pending';
  const pnlEl=document.getElementById('ws-pnl');
  pnlEl.textContent=(totalPnl>=0?'+':'')+f$(totalPnl);
  pnlEl.className=pc(totalPnl);

  // Tracked whale cards
  renderWhaleCards(allWithTrades);

  // Timeline
  renderWhaleTimeline(d.recent_trades,whales);

  // All whales leaderboard
  const allSorted=[...whales].sort((a,b)=>a.rank-b.rank);
  const maxWPnl=Math.max(...allSorted.map(w=>Math.abs(w.our_pnl||0)).filter(v=>v>0),1);
  document.querySelector('#whale-all tbody').innerHTML=allSorted.map(w=>{
    const name=w.name||w.address?.slice(0,8)||'‚Äî';
    const pnlPct=Math.min(Math.abs(w.our_pnl||0)/maxWPnl*100,100);
    const pnlColor=(w.our_pnl||0)>=0?'var(--green)':'var(--red)';
    return`<tr>
      <td style="font-weight:600;color:var(--text2)">#${w.rank}</td>
      <td><span style="color:var(--blue);font-weight:600">${name}</span></td>
      <td style="color:var(--green)">${w.weekly_pnl||'‚Äî'}</td>
      <td>${w.volume||'‚Äî'}</td>
      <td class="pnl-bar-cell"><div class="pnl-bar-bg" style="width:${pnlPct}%;background:${pnlColor}"></div><span class="pnl-bar-text ${pc(w.our_pnl)}" style="font-weight:600">${w.tracked?f$(w.our_pnl):'‚Äî'}</span></td>
      <td>${w.tracked?'<span class="badge b-a">Tracked</span>':'<button class="btn-track">+ Track</button>'}</td></tr>`}).join('');

  // P&L chart removed (was using dummy data)
}

refresh();setInterval(refresh,60000);loadWhale();setInterval(loadWhale,60000);
</script>
</body>
</html>
