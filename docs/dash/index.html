<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BTC Trading Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0d1117;color:#c9d1d9;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;padding:16px}
a{color:#58a6ff}
.header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.header h1{font-size:1.4rem;color:#f0f6fc}
.health-bar{display:flex;gap:12px;flex-wrap:wrap;background:#161b22;border:1px solid #30363d;border-radius:8px;padding:8px 14px}
.health-item{display:flex;align-items:center;gap:5px;font-size:.8rem;color:#8b949e}
.health-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.dot-green{background:#3fb950}.dot-red{background:#f85149}.dot-gray{background:#484f58}
.tabs{display:flex;gap:4px;margin-bottom:16px}
.tab{padding:10px 20px;border-radius:8px 8px 0 0;cursor:pointer;font-weight:600;font-size:.95rem;border:1px solid #30363d;border-bottom:none;background:#161b22;color:#8b949e;transition:all .15s}
.tab.active{background:#0d1117;color:#f0f6fc;border-color:#58a6ff;border-bottom:1px solid #0d1117;position:relative;z-index:1}
.tab-content{display:none}.tab-content.active{display:block}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px}
.card{background:#161b22;border:1px solid #30363d;border-radius:10px;padding:16px}
.card-label{font-size:.75rem;color:#8b949e;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.card-value{font-size:1.5rem;font-weight:700;color:#f0f6fc}
.green{color:#3fb950}.red{color:#f85149}
.chart-container{background:#161b22;border:1px solid #30363d;border-radius:10px;padding:16px;margin-bottom:20px;position:relative;height:300px}
table{width:100%;border-collapse:collapse;background:#161b22;border:1px solid #30363d;border-radius:10px;overflow:hidden;margin-bottom:20px}
th,td{padding:10px 12px;text-align:left;font-size:.85rem;border-bottom:1px solid #21262d}
th{background:#161b22;color:#8b949e;cursor:pointer;user-select:none;position:sticky;top:0;white-space:nowrap}
th:hover{color:#c9d1d9}
th .arrow{margin-left:4px;font-size:.7rem}
td{color:#c9d1d9}
.badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:.7rem;font-weight:600}
.badge-active{background:#23812e33;color:#3fb950;border:1px solid #3fb95044}
.badge-shadow{background:#484f5833;color:#8b949e;border:1px solid #8b949e44}
.signal-row td{font-size:.8rem}
.refresh-info{font-size:.7rem;color:#484f58;text-align:right;margin-bottom:8px}
.table-wrap{overflow-x:auto;border-radius:10px;margin-bottom:20px}
@media(max-width:600px){
  body{padding:8px}
  .card-value{font-size:1.2rem}
  .chart-container{height:220px}
  .tabs{gap:2px}
  .tab{padding:8px 12px;font-size:.85rem}
}
</style>
</head>
<body>
<div class="header">
  <h1>â‚¿ BTC Trading Bot</h1>
  <div class="health-bar" id="healthBar">
    <div class="health-item"><span class="health-dot dot-gray" id="h-signal"></span>Signal Engine</div>
    <div class="health-item"><span class="health-dot dot-gray" id="h-paper"></span>Paper Trader</div>
    <div class="health-item"><span class="health-dot dot-gray" id="h-live"></span>Live Trader</div>
    <div class="health-item"><span class="health-dot dot-gray" id="h-api"></span>API</div>
  </div>
</div>
<div class="refresh-info" id="refreshInfo">Loading...</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('paper')">ðŸ“Š Paper Trading</div>
  <div class="tab" onclick="switchTab('live')">ðŸ”´ Live Trading</div>
</div>

<div class="tab-content active" id="tab-paper">
  <div class="cards" id="paper-cards"></div>
  <div class="chart-container"><canvas id="paperChart"></canvas></div>
  <h3 style="margin-bottom:8px;color:#8b949e;font-size:.9rem">Strategy Performance</h3>
  <div class="table-wrap"><table id="paper-table"><thead><tr></tr></thead><tbody></tbody></table></div>
  <h3 style="margin-bottom:8px;color:#8b949e;font-size:.9rem">Recent Signals</h3>
  <div class="table-wrap"><table id="paper-signals"><thead><tr><th>Time</th><th>Strategy</th><th>Dir</th><th>Price</th><th>Conf</th><th>Outcome</th></tr></thead><tbody></tbody></table></div>
</div>

<div class="tab-content" id="tab-live">
  <div class="cards" id="live-cards"></div>
  <h3 style="margin-bottom:8px;color:#8b949e;font-size:.9rem">Polymarket Positions</h3>
  <div class="table-wrap"><table id="live-positions"><thead><tr><th>Market</th><th>Side</th><th>Size</th><th>Avg Price</th><th>Invested</th><th>Current</th><th>P&L</th><th>Status</th></tr></thead><tbody></tbody></table></div>
</div>

<script>
const API='https://dashboard.peytoncampbell.ca';
const KEY='65bc4d4ad01756a528c74480067c330da9461584b3b7347e';
const H={headers:{'X-API-Key':KEY}};
let paperChart,liveChart,activeTab='paper',sortState={paper:{col:null,asc:true},live:{col:null,asc:true}};
let strategiesData=[],paperStats=[],liveStats=[];

async function api(path){try{const r=await fetch(API+path,H);if(!r.ok)throw r;return r.json()}catch(e){console.error(path,e);return null}}

function switchTab(t){
  activeTab=t;
  document.querySelectorAll('.tab').forEach((el,i)=>el.classList.toggle('active',i===(t==='paper'?0:1)));
  document.querySelectorAll('.tab-content').forEach((el,i)=>el.classList.toggle('active',i===(t==='paper'?0:1)));
}

function pnlClass(v){return v>=0?'green':'red'}
function fmt(v,d=2){return v==null?'â€”':Number(v).toFixed(d)}
function fmtPct(v){return v==null?'â€”':fmt(v,1)+'%'}
function fmtUsd(v){return v==null?'â€”':'$'+fmt(v,2)}
function fmtTime(t){if(!t)return'â€”';const d=new Date(t);return d.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' '+d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}

function renderCards(id,stats,strategies,mode){
  const el=document.getElementById(id);
  const strats=mode==='live'?strategies.filter(s=>s.status==='ACTIVE'):strategies;
  const totalPnl=stats.reduce((a,s)=>a+(s.total_pnl||s.pnl||0),0);
  const totalTrades=stats.reduce((a,s)=>a+(s.total_trades||s.trades||0),0);
  const wins=stats.reduce((a,s)=>a+(s.wins||0),0);
  const wr=totalTrades?((wins/totalTrades)*100):0;
  el.innerHTML=`
    <div class="card"><div class="card-label">Total P&L</div><div class="card-value ${pnlClass(totalPnl)}">${fmtUsd(totalPnl)}</div></div>
    <div class="card"><div class="card-label">Win Rate</div><div class="card-value">${fmtPct(wr)}</div></div>
    <div class="card"><div class="card-label">Total Trades</div><div class="card-value">${totalTrades}</div></div>
    <div class="card"><div class="card-label">Strategies</div><div class="card-value">${strats.length}</div></div>`;
}

const cols=[
  {key:'name',label:'Strategy',fmt:v=>v},
  {key:'status',label:'Status',fmt:v=>`<span class="badge badge-${v==='ACTIVE'?'active':'shadow'}">${v}</span>`},
  {key:'pnl',label:'P&L ($)',fmt:v=>`<span class="${pnlClass(v)}">${fmtUsd(v)}</span>`,num:true},
  {key:'wr',label:'Win Rate',fmt:v=>fmtPct(v),num:true},
  {key:'pdd',label:'P/DD',fmt:v=>fmt(v,2),num:true},
  {key:'trades',label:'Trades',fmt:v=>v,num:true}
];

function mergeStats(strategies,stats,mode){
  const smap=Object.fromEntries((stats||[]).map(s=>[s.strategy_name||s.name,s]));
  const stratMap=Object.fromEntries((strategies||[]).map(s=>[s.name,s]));
  let list;
  if(mode==='live'){
    list=strategies.filter(s=>s.status==='ACTIVE').map(s=>{
      const st=smap[s.name]||{};
      return{name:s.name,status:s.status,pnl:st.total_pnl||0,wr:(st.win_rate||0)*100,pdd:st.pdd_ratio||0,trades:st.total_trades||0};
    });
  } else {
    // Paper: show ALL strategies that have stats, even if not in config
    const seen=new Set();
    list=[];
    for(const s of (stats||[])){
      const n=s.strategy_name||s.name;
      seen.add(n);
      const info=stratMap[n];
      list.push({name:n,status:info?info.status:'LEGACY',pnl:s.total_pnl||0,wr:(s.win_rate||0)*100,pdd:s.pdd_ratio||0,trades:s.total_trades||0});
    }
    // Add configured strategies with no stats
    for(const s of strategies){
      if(!seen.has(s.name)) list.push({name:s.name,status:s.status,pnl:0,wr:0,pdd:0,trades:0});
    }
  }
  return list;
}

function renderTable(tableId,rows,mode){
  const table=document.getElementById(tableId);
  const thead=table.querySelector('thead tr');
  const ss=sortState[mode];
  thead.innerHTML=cols.map(c=>{
    let arrow='';
    if(ss.col===c.key)arrow=`<span class="arrow">${ss.asc?'â–²':'â–¼'}</span>`;
    return`<th data-key="${c.key}">${c.label}${arrow}</th>`;
  }).join('');
  thead.querySelectorAll('th').forEach(th=>{
    th.onclick=()=>{
      const k=th.dataset.key;
      if(ss.col===k)ss.asc=!ss.asc;else{ss.col=k;ss.asc=true}
      renderTable(tableId,rows,mode);
    };
  });
  if(ss.col){
    const c=cols.find(c=>c.key===ss.col);
    rows.sort((a,b)=>{
      let av=a[ss.col],bv=b[ss.col];
      if(c&&c.num){av=Number(av)||0;bv=Number(bv)||0}else{av=String(av).toLowerCase();bv=String(bv).toLowerCase()}
      return ss.asc?(av>bv?1:-1):(av<bv?1:-1);
    });
  }
  table.querySelector('tbody').innerHTML=rows.map(r=>
    `<tr>${cols.map(c=>`<td>${c.fmt(r[c.key])}</td>`).join('')}</tr>`
  ).join('');
}

function renderSignals(tableId,signals,activeOnly){
  const activeNames=new Set(strategiesData.filter(s=>s.status==='ACTIVE').map(s=>s.name));
  let list=(signals||[]);
  if(activeOnly)list=list.filter(s=>activeNames.has(s.strategy_name));
  document.getElementById(tableId).querySelector('tbody').innerHTML=list.slice(0,30).map(s=>{
    const oc=s.outcome==='WIN'?'green':s.outcome==='LOSS'?'red':'';
    return`<tr class="signal-row"><td>${fmtTime(s.timestamp)}</td><td>${s.strategy_name||'â€”'}</td><td>${s.direction||'â€”'}</td><td>${fmtUsd(s.buy_price)}</td><td>${fmtPct(s.confidence)}</td><td class="${oc}">${s.outcome||'PENDING'}</td></tr>`;
  }).join('');
}

function makeChart(ctx,data,label){
  const pts=(data||[]).map(d=>({x:new Date(d.t),y:d.b}));
  return new Chart(ctx,{type:'line',data:{datasets:[{label,data:pts,borderColor:'#58a6ff',backgroundColor:'rgba(88,166,255,.08)',fill:true,pointRadius:0,tension:.3,borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,interaction:{intersect:false,mode:'index'},plugins:{legend:{display:false}},scales:{x:{type:'time',grid:{color:'#21262d'},ticks:{color:'#484f58',maxTicksLimit:8}},y:{grid:{color:'#21262d'},ticks:{color:'#484f58',callback:v=>'$'+v.toFixed(0)}}}}});
}

function updateChart(chart,data){
  const pts=(data||[]).map(d=>({x:new Date(d.t),y:d.b}));
  chart.data.datasets[0].data=pts;chart.update('none');
}

async function refresh(){
  const[health,strategies,pStats,positions,signals,pEquity]=await Promise.all([
    api('/api/health'),api('/api/strategies'),api('/api/stats?mode=paper'),
    api('/api/positions'),api('/api/signals?limit=50'),api('/api/equity?mode=paper&points=300')
  ]);
  // Health
  if(health){
    const now=Date.now();
    const check=(id,ts)=>{
      const dot=document.getElementById(id);
      if(!ts){dot.className='health-dot dot-gray';return}
      dot.className='health-dot '+((now-new Date(ts).getTime())<120000?'dot-green':'dot-red');
    };
    const hbTs=(o)=>o&&(o.last_heartbeat||o.ts||o);
    check('h-signal',hbTs(health.signal_engine)||health.last_signal);
    check('h-paper',hbTs(health.paper_trader)||health.last_paper_trade);
    check('h-live',hbTs(health.live_trader)||health.last_live_trade);
    document.getElementById('h-api').className='health-dot dot-green';
  }
  // Strategies
  strategiesData=(strategies&&strategies.strategies)||strategies||[];
  paperStats=(pStats&&(pStats.stats||pStats.strategies))||pStats||[];
  const sigs=(signals&&signals.signals)||signals||[];
  // Paper tab
  renderCards('paper-cards',paperStats,strategiesData,'paper');
  const pRows=mergeStats(strategiesData,paperStats,'paper');
  renderTable('paper-table',pRows,'paper');
  renderSignals('paper-signals',sigs,false);
  const pe=(pEquity&&pEquity.equity)||pEquity||[];
  if(!paperChart)paperChart=makeChart(document.getElementById('paperChart'),pe,'Paper Equity');
  else updateChart(paperChart,pe);
  // Live tab â€” Polymarket positions
  if(positions){
    const s=positions.summary||{};
    const el=document.getElementById('live-cards');
    el.innerHTML=`
      <div class="card"><div class="card-label">Wallet Balance</div><div class="card-value">${s.balance!=null?fmtUsd(s.balance):'â€”'}</div></div>
      <div class="card"><div class="card-label">Total P&L</div><div class="card-value ${pnlClass(s.total_pnl)}">${fmtUsd(s.total_pnl)}</div></div>
      <div class="card"><div class="card-label">Invested</div><div class="card-value">${fmtUsd(s.total_invested)}</div></div>
      <div class="card"><div class="card-label">Positions</div><div class="card-value">${(positions.positions||[]).length} (${s.wins}W/${s.losses}L)</div></div>`;
    const tbody=document.getElementById('live-positions').querySelector('tbody');
    tbody.innerHTML=(positions.positions||[]).map(p=>{
      const status=p.redeemable?'<span style="color:#f0883e">Redeemable</span>':(p.current_value>0?'<span style="color:#58a6ff">Open</span>':'<span style="color:#484f58">Settled</span>');
      return`<tr><td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.title}</td><td>${p.outcome}</td><td>${fmt(p.size,1)}</td><td>${fmtUsd(p.avg_price)}</td><td>${fmtUsd(p.initial_value)}</td><td>${fmtUsd(p.current_value)}</td><td class="${pnlClass(p.pnl)}">${fmtUsd(p.pnl)}</td><td>${status}</td></tr>`;
    }).join('');
  }
  document.getElementById('refreshInfo').textContent='Last refresh: '+new Date().toLocaleTimeString()+' Â· Auto-refresh 30s';
}
refresh();setInterval(refresh,30000);
</script>
</body>
</html>
