<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title>Trading Dashboard</title>
<link rel="icon" href="/dash/favicon.ico">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<style>
:root{--bg:#0d1117;--surface:#161b22;--border:#21262d;--border2:#30363d;--text:#c9d1d9;--text2:#8b949e;--text3:#484f58;--white:#f0f6fc;--blue:#58a6ff;--green:#3fb950;--red:#f85149;--orange:#d29922}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-size:13px;padding:12px 16px;max-width:1400px;margin:0 auto}
.hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.hdr h1{font-size:1.1rem;color:var(--white);font-weight:700;letter-spacing:-.3px}
.hdr-right{display:flex;align-items:center;gap:14px}
.health{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text2)}
.dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.dot-g{background:var(--green)}.dot-r{background:var(--red)}.dot-x{background:var(--text3)}
.refresh{font-size:10px;color:var(--text3)}
.tabs{display:flex;gap:0;margin-bottom:12px;border-bottom:1px solid var(--border2)}
.tab{padding:7px 18px;cursor:pointer;font-weight:600;font-size:12px;color:var(--text2);border-bottom:2px solid transparent;transition:all .15s}
.tab:hover{color:var(--text)}.tab.on{color:var(--blue);border-bottom-color:var(--blue)}
.pane{display:none}.pane.on{display:block}
.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px}
.card-l{font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:.6px;margin-bottom:2px}
.card-v{font-size:1.25rem;font-weight:700;color:var(--white)}
.g{color:var(--green)}.r{color:var(--red)}
.chart-box{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 12px;margin-bottom:12px;height:200px;position:relative}
.tbl-wrap{overflow-x:auto;border-radius:8px;border:1px solid var(--border);margin-bottom:12px;max-height:340px;overflow-y:auto}
table{width:100%;border-collapse:collapse;background:var(--surface)}
th,td{padding:5px 10px;text-align:left;font-size:12px;border-bottom:1px solid var(--border);white-space:nowrap}
th{background:var(--bg);color:var(--text2);cursor:pointer;user-select:none;position:sticky;top:0;z-index:1;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.4px}
th:hover{color:var(--text)}
.badge{display:inline-block;padding:1px 7px;border-radius:10px;font-size:10px;font-weight:600}
.b-a{background:#23812e22;color:var(--green)}.b-s{background:#484f5822;color:var(--text3)}.b-l{background:#58a6ff22;color:var(--blue)}
.pnl-section{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px}
.pnl-tabs{display:flex;gap:0;margin-bottom:12px;border-bottom:1px solid var(--border2)}
.pnl-tab{padding:6px 16px;cursor:pointer;font-weight:600;font-size:11px;color:var(--text2);border-bottom:2px solid transparent;transition:all .15s;text-transform:uppercase;letter-spacing:.5px}
.pnl-tab:hover{color:var(--text)}.pnl-tab.on{color:var(--blue);border-bottom-color:var(--blue)}
.pnl-display{display:flex;align-items:center;gap:12px}
.pnl-amount{font-size:1.75rem;font-weight:700;color:var(--white)}
.pnl-percent{font-size:1rem;font-weight:600;padding:3px 8px;border-radius:6px}
.feed{display:flex;flex-direction:column;gap:4px;max-height:500px;overflow-y:auto}
.fi{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 10px}
.fi-icon{width:22px;height:22px;border-radius:50%;flex-shrink:0}
.fi-body{flex:1;min-width:0}
.fi-title{font-size:11px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fi-sub{font-size:10px;color:var(--text2);margin-top:1px}
.fi-amt{font-size:12px;font-weight:600;white-space:nowrap;margin-left:8px}
.fi-tag{font-size:9px;padding:2px 6px;border-radius:8px;white-space:nowrap;margin-left:6px;font-weight:600}
.t-claim{background:#1a3a2a;color:var(--green)}.t-buy{background:#1c2a3a;color:var(--blue)}.t-other{background:#2d2a1a;color:var(--orange)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.section-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;font-weight:600}
.tracked-row{background:rgba(88,166,255,0.04)}
@media(max-width:768px){.cards{grid-template-columns:repeat(2,1fr)}.row{grid-template-columns:1fr}.chart-box{height:180px}}
@media(max-width:480px){body{padding:8px}.card-v{font-size:1rem}.tabs{overflow-x:auto}}
</style>
</head>
<body>
<div id="stage-banner" style="background:linear-gradient(90deg,#d29922,#f0883e);color:#0d1117;text-align:center;padding:8px 16px;border-radius:8px;margin-bottom:10px;font-weight:700;font-size:13px;display:none">
  ‚ö†Ô∏è STAGE 0 ‚Äî PAPER ONLY ‚Äî No live orders permitted
</div>
<div class="hdr">
  <h1>üìä Trading Dashboard</h1>
  <div class="hdr-right">
    <div class="health"><span class="dot dot-x" id="h-sig"></span>Signals</div>
    <div class="health"><span class="dot dot-x" id="h-pap"></span>Paper</div>
    <div class="health"><span class="dot dot-x" id="h-liv"></span>Live</div>
    <div class="health"><span class="dot dot-x" id="h-api"></span>API</div>
    <span class="refresh" id="ref">‚Äî</span>
  </div>
</div>

<div class="tabs">
  <div class="tab on" onclick="sw('paper')">üìä Paper Trading</div>
  <div class="tab" onclick="sw('whale')">üêã Whale Copy</div>
  <div class="tab" onclick="sw('live')">üî¥ Live Trading</div>
</div>

<!-- Paper Trading (V2 EV-Gated) -->
<div class="pane on" id="p-paper">
  <div class="cards" id="v2c"></div>
  <div class="section-label">EV Gate Metrics</div>
  <div class="cards" id="v2ev"></div>
  <div class="section-label" style="margin-top:12px">Strategy Leaderboard</div>
  <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
    <select id="v2-sort" onchange="refreshV2Leaderboard()" style="background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:4px 8px;font-size:12px">
      <option value="total_pnl">Sort: Total PnL</option><option value="avg_pnl">Avg PnL</option>
      <option value="edge_lb">Edge LB</option><option value="p10_win_rate">P10 Win%</option>
      <option value="take_rate">Take Rate</option><option value="calibration_gap">Calib Gap</option>
    </select>
    <label style="font-size:12px;color:var(--text2);cursor:pointer"><input type="checkbox" id="v2-small" onchange="refreshV2Leaderboard()"> Show small samples</label>
  </div>
  <div class="tbl-wrap"><table id="v2-lb"><thead><tr>
    <th>Strategy</th><th>Trades</th><th>Win%</th><th title="Bayesian 10th percentile win rate">P10 Win%</th><th>PnL</th><th>Avg PnL</th><th>Take Rate</th><th title="Lower bound edge">Edge LB</th><th>Calib Gap</th><th>Badges</th>
  </tr></thead><tbody></tbody></table></div>
  <div id="v2-detail" style="display:none;margin-bottom:12px"></div>
</div>

<!-- Whale Copy Trading -->
<div class="pane" id="p-whale">
  <div class="cards" id="whale-cards"></div>
  <div class="row">
    <div>
      <div class="section-label">Tracked Whales</div>
      <div class="tbl-wrap" style="max-height:400px"><table id="whale-lb"><thead><tr>
        <th>Name</th><th>Rank</th><th>Weekly PnL</th><th>Volume</th><th>Our Copies</th><th>Our PnL</th><th>Our WR</th><th>Status</th>
      </tr></thead><tbody></tbody></table></div>
    </div>
    <div>
      <div class="section-label">Recent Copy Trades</div>
      <div class="tbl-wrap" style="max-height:400px"><table id="whale-trades"><thead><tr>
        <th>Time</th><th>Market</th><th>Side</th><th>Whale $</th><th>Our $</th><th>Size</th><th>Status</th><th>P&L</th>
      </tr></thead><tbody></tbody></table></div>
    </div>
  </div>
  <div class="section-label" style="margin-top:12px">All Whales (Top 100)</div>
  <div class="tbl-wrap"><table id="whale-all"><thead><tr>
    <th>Rank</th><th>Name</th><th>Weekly PnL</th><th>Volume</th><th>Tracked</th>
  </tr></thead><tbody></tbody></table></div>
</div>

<!-- Live Trading -->
<div class="pane" id="p-live">
  <div class="cards" id="lc"></div>
  <div class="section-label">P&L Performance</div>
  <div class="pnl-section">
    <div class="pnl-tabs">
      <div class="pnl-tab on" onclick="setPnlPeriod('1d')">1D</div>
      <div class="pnl-tab" onclick="setPnlPeriod('1w')">1W</div>
      <div class="pnl-tab" onclick="setPnlPeriod('1m')">1M</div>
      <div class="pnl-tab" onclick="setPnlPeriod('all')">ALL</div>
    </div>
    <div class="pnl-display">
      <div class="pnl-amount" id="pnl-amount">‚Äî</div>
      <div class="pnl-percent" id="pnl-percent">‚Äî</div>
    </div>
  </div>
  <div class="chart-box" style="height:280px;margin-bottom:16px;"><canvas id="pnlChart"></canvas></div>
  <div class="section-label">Recent Activity</div>
  <div class="feed" id="feed"></div>
</div>

<script>
const API='https://api.peytoncampbell.ca',KEY='65bc4d4ad01756a528c74480067c330da9461584b3b7347e',H={headers:{'X-API-Key':KEY}};
let pnlChart,currentPnlPeriod='1d';
async function q(p){try{const r=await fetch(API+p,H);if(!r.ok)throw r;return r.json()}catch{return null}}
function sw(t){const tabs=['paper','whale','live'];document.querySelectorAll('.tab').forEach((e,i)=>e.classList.toggle('on',i===tabs.indexOf(t)));tabs.forEach(id=>document.getElementById('p-'+id).classList.toggle('on',id===t))}
const f2=(v,d=2)=>v==null?'‚Äî':Number(v).toFixed(d);
const f$=v=>v==null?'‚Äî':'$'+f2(v);
const fP=v=>v==null?'‚Äî':f2(v,1)+'%';
const pc=v=>v>=0?'g':'r';

function mkPnlChart(ctx,data){
  const pts=(data||[]).map(d=>({x:new Date(d.timestamp),y:d.cumulative_pnl!=null?d.cumulative_pnl:d.pnl}));
  const color=pts.length&&pts[pts.length-1].y>=0?'#3fb950':'#f85149';
  return new Chart(ctx,{type:'line',data:{datasets:[{data:pts,borderColor:color,backgroundColor:color+'15',fill:true,pointRadius:1,tension:.2,borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,animation:{duration:300},interaction:{intersect:false,mode:'index'},plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>'$'+c.parsed.y.toFixed(2)}}},scales:{x:{type:'time',grid:{color:'#161b22'},ticks:{color:'var(--text3)',maxTicksLimit:8,font:{size:10}}},y:{grid:{color:'#161b22'},ticks:{color:'var(--text3)',font:{size:10},callback:v=>'$'+v.toFixed(2)}}}}});
}

async function setPnlPeriod(period){
  currentPnlPeriod=period;
  document.querySelectorAll('.pnl-tab').forEach(t=>t.classList.remove('on'));
  document.querySelector(`[onclick="setPnlPeriod('${period}')"]`).classList.add('on');
  await refreshPnl();
}

async function refreshPnl(){
  const pnl=await q(`/api/pnl?period=${currentPnlPeriod}`);
  if(pnl){
    const amt=document.getElementById('pnl-amount');
    const pct=document.getElementById('pnl-percent');
    amt.textContent=f$(pnl.pnl);
    amt.className=`pnl-amount ${pc(pnl.pnl)}`;
    if(pnl.pnl_pct!=null){
      pct.textContent=`(${pnl.pnl_pct>=0?'+':''}${fP(pnl.pnl_pct)})`;
      pct.className=`pnl-percent ${pc(pnl.pnl_pct)}`;
      pct.style.backgroundColor=pnl.pnl_pct>=0?'rgba(63,185,80,0.15)':'rgba(248,81,73,0.15)';
    }
    if(!pnlChart)pnlChart=mkPnlChart(document.getElementById('pnlChart'),pnl.equity_curve);
    else{
      const pts=(pnl.equity_curve||[]).map(d=>({x:new Date(d.timestamp),y:d.cumulative_pnl!=null?d.cumulative_pnl:d.pnl}));
      const color=pts.length&&pts[pts.length-1].y>=0?'#3fb950':'#f85149';
      pnlChart.data.datasets[0].data=pts;pnlChart.data.datasets[0].borderColor=color;pnlChart.data.datasets[0].backgroundColor=color+'15';pnlChart.update('none');
    }
  }
}

function v2Badge(s){
  if(s.disable_recommendation)return'<span class="badge" style="background:#f8514922;color:var(--red)">‚õî Disable</span>';
  if(s.kill_candidate)return'<span class="badge" style="background:#f8514922;color:var(--red)">üíÄ Kill</span>';
  if(s.watchlist)return'<span class="badge" style="background:#3fb95022;color:var(--green)">‚≠ê Watch</span>';
  if(s.small_sample)return'<span class="badge" style="background:#484f5822;color:var(--text3)">üìä Small</span>';
  return'‚Äî';
}

async function refreshV2Leaderboard(){
  const sort=document.getElementById('v2-sort')?.value||'total_pnl';
  const mt=document.getElementById('v2-small')?.checked?3:20;
  const d=await q(`/api/paper_v2_strategies?min_trades=${mt}&sort=${sort}`);
  if(!d||!d.strategies)return;
  document.querySelector('#v2-lb tbody').innerHTML=d.strategies.map(s=>
    `<tr style="cursor:pointer" onclick="showV2Detail('${s.strategy_name}')">
      <td style="color:var(--blue);font-weight:600">${s.strategy_name}</td>
      <td>${s.trades_resolved}</td><td>${fP(s.win_rate*100)}</td><td>${fP(s.p10_win_rate*100)}</td>
      <td class="${pc(s.total_pnl)}">${f$(s.total_pnl)}</td><td class="${pc(s.avg_pnl)}">${f$(s.avg_pnl)}</td>
      <td>${fP(s.take_rate*100)}</td><td class="${pc(s.edge_lb)}">${f2(s.edge_lb,4)}</td>
      <td class="${pc(s.calibration_gap)}">${f2(s.calibration_gap,4)}</td><td>${v2Badge(s)}</td></tr>`
  ).join('');
}

async function showV2Detail(name){
  const el=document.getElementById('v2-detail');
  if(el.dataset.open===name){el.style.display='none';el.dataset.open='';return;}
  const d=await q('/api/paper_v2_strategy?name='+encodeURIComponent(name));
  if(!d)return;
  const sm=d.summary||{};
  let h=`<div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px;margin-top:8px">
    <div style="font-weight:700;color:var(--white);margin-bottom:8px;font-size:14px">${name} ‚Äî Detail</div>
    <div style="display:flex;gap:16px;margin-bottom:8px;font-size:12px;color:var(--text2)">
      <span>Trades: ${sm.total||0}</span><span>PnL: <b class="${pc(sm.total_pnl)}">${f$(sm.total_pnl)}</b></span>
      <span>P10 Win%: <b>${sm.p10_win_rate!=null?fP(sm.p10_win_rate*100):'‚Äî'}</b></span>
      <span>Edge LB: <b class="${pc(sm.edge_lb)}">${sm.edge_lb!=null?f2(sm.edge_lb,4):'‚Äî'}</b></span>
    </div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">`;
  if(d.by_price_bucket?.length){
    h+=`<div><div class="section-label">By Price Bucket</div><div class="tbl-wrap" style="max-height:200px"><table><thead><tr><th>Bucket</th><th>#</th><th>Wins</th><th>PnL</th></tr></thead><tbody>`;
    d.by_price_bucket.forEach(r=>{h+=`<tr><td>${r.price_bucket||'‚Äî'}</td><td>${r.trades}</td><td>${r.wins}</td><td class="${pc(r.pnl)}">${f$(r.pnl)}</td></tr>`});
    h+=`</tbody></table></div></div>`;
  }
  if(d.by_tod_bucket?.length){
    h+=`<div><div class="section-label">By Time of Day</div><div class="tbl-wrap" style="max-height:200px"><table><thead><tr><th>TOD</th><th>#</th><th>Wins</th><th>PnL</th></tr></thead><tbody>`;
    d.by_tod_bucket.forEach(r=>{h+=`<tr><td>${r.tod_bucket||'‚Äî'}</td><td>${r.trades}</td><td>${r.wins}</td><td class="${pc(r.pnl)}">${f$(r.pnl)}</td></tr>`});
    h+=`</tbody></table></div></div>`;
  }
  h+=`</div>`;
  if(d.ev_decisions?.length){
    h+=`<div class="section-label" style="margin-top:8px">EV Decisions</div><div style="display:flex;gap:8px;flex-wrap:wrap">`;
    d.ev_decisions.forEach(r=>{h+=`<span class="badge ${r.decision==='TAKE'?'b-a':'b-s'}" style="font-size:11px;padding:3px 10px">${r.decision}: ${r.cnt}</span>`});
    h+=`</div>`;
  }
  if(d.recent_trades?.length){
    h+=`<div class="section-label" style="margin-top:8px">Recent Trades (last 10)</div><div class="tbl-wrap" style="max-height:240px"><table><thead><tr><th>Time</th><th>Side</th><th>Price</th><th>Result</th><th>PnL</th><th>EV Est</th></tr></thead><tbody>`;
    d.recent_trades.slice(0,10).forEach(r=>{
      const t=r.timestamp?new Date(r.timestamp).toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}):'‚Äî';
      h+=`<tr><td>${t}</td><td>${r.side||'‚Äî'}</td><td>${f$(r.buy_price)}</td><td class="${r.outcome==='WIN'?'g':r.outcome==='LOSS'?'r':''}">${r.outcome||'PENDING'}</td><td class="${pc(r.pnl)}">${r.pnl!=null?f$(r.pnl):'‚Äî'}</td><td>${r.ev_est!=null?f2(r.ev_est,4):'‚Äî'}</td></tr>`;
    });
    h+=`</tbody></table></div>`;
  }
  h+=`</div>`;
  el.innerHTML=h;el.style.display='block';el.dataset.open=name;
}

async function refresh(){
  const[health,pos]=await Promise.all([q('/api/health'),q('/api/positions')]);
  if(health){
    const now=Date.now();
    const chk=(id,o)=>{const ts=o&&(o.last_heartbeat||o.ts||o);document.getElementById(id).className='dot '+(ts&&(now-new Date(ts).getTime())<120000?'dot-g':'dot-r')};
    chk('h-sig',health.signal_engine);chk('h-pap',health.paper_trader);chk('h-liv',health.live_trader);
    document.getElementById('h-api').className='dot dot-g';
  }
  if(pos){
    const s=pos.summary||{};
    const dailyPnl=await q('/api/pnl?period=1d');
    const dd=dailyPnl?`<span class="${pc(dailyPnl.pnl)}">${dailyPnl.pnl>=0?'+':''}${f$(dailyPnl.pnl)} (${dailyPnl.pnl_pct>=0?'+':''}${fP(dailyPnl.pnl_pct)})</span>`:'‚Äî';
    document.getElementById('lc').innerHTML=`
      <div class="card"><div class="card-l">Portfolio</div><div class="card-v">${s.balance!=null?f$(s.balance):'‚Äî'}</div></div>
      <div class="card"><div class="card-l">Cash</div><div class="card-v">${s.cash_balance!=null?f$(s.cash_balance):'‚Äî'}</div></div>
      <div class="card"><div class="card-l">Total Redeemed</div><div class="card-v g">${s.total_redeemed!=null?f$(s.total_redeemed):'‚Äî'}</div></div>
      <div class="card"><div class="card-l">Daily Change</div><div class="card-v">${dd}</div></div>`;
    const now=Date.now()/1000;
    document.getElementById('feed').innerHTML=(pos.activity||[]).map(a=>{
      const ic=a.icon?`<img class="fi-icon" src="${a.icon}">`:'';
      if(a.type==='REDEEM')return`<div class="fi">${ic}<div class="fi-body"><div class="fi-title">${a.title}</div><div class="fi-sub">Claimed</div></div><div class="fi-amt g">+${f$(a.usdc)}</div><div class="fi-tag t-claim">Claimed</div></div>`;
      if(a.type==='TRADE'&&a.side==='BUY'){const m=Math.round((now-a.timestamp)/60);const ago=m<60?m+'m':m<1440?Math.round(m/60)+'h':Math.round(m/1440)+'d';return`<div class="fi">${ic}<div class="fi-body"><div class="fi-title">${a.title}</div><div class="fi-sub">Bought ${Math.round(a.size)} ${a.outcome} at ${Math.round(a.price*100)}¬¢</div></div><div class="fi-amt" style="color:var(--text2)">-${f$(a.usdc)}</div><div class="fi-tag t-buy">${ago} ago</div></div>`}
      return`<div class="fi">${ic}<div class="fi-body"><div class="fi-title">${a.title}</div><div class="fi-sub">${a.type} ${a.outcome||''}</div></div><div class="fi-amt">${f$(a.usdc)}</div><div class="fi-tag t-other">${a.type}</div></div>`;
    }).join('');
  }
  if(document.querySelector('#p-live.on'))await refreshPnl();
  const stage=await q('/api/stage');
  document.getElementById('stage-banner').style.display=(stage&&stage.trading_stage==='STAGE_0')?'block':'none';
  const v2=await q('/api/paper_v2_stats');
  if(v2&&!v2.error){
    document.getElementById('v2c').innerHTML=`
      <div class="card"><div class="card-l">Total P&L</div><div class="card-v ${pc(v2.total_pnl)}">${f$(v2.total_pnl)}</div></div>
      <div class="card"><div class="card-l">Win Rate</div><div class="card-v">${fP(v2.win_rate*100)}</div></div>
      <div class="card"><div class="card-l">Trades Taken</div><div class="card-v">${v2.trades_taken}</div></div>
      <div class="card"><div class="card-l">Max Drawdown</div><div class="card-v r">${f$(v2.max_drawdown)}</div></div>`;
    document.getElementById('v2ev').innerHTML=`
      <div class="card"><div class="card-l">Take Rate</div><div class="card-v">${fP(v2.take_rate*100)}</div></div>
      <div class="card"><div class="card-l">Trades Skipped</div><div class="card-v">${v2.trades_skipped}</div></div>
      <div class="card"><div class="card-l">Avg Predicted EV</div><div class="card-v">${f2(v2.avg_predicted_ev,4)}</div></div>
      <div class="card"><div class="card-l">Calibration Error</div><div class="card-v">${f2(v2.calibration_error,4)}</div></div>`;
  }
  await refreshV2Leaderboard();
  document.getElementById('ref').textContent=new Date().toLocaleTimeString()+' ¬∑ 60s';
}

async function loadWhale(){
  const d=await q('/api/whales');
  if(!d)return;
  const s=d.summary||{};
  const whales=d.whales||[];
  const tracked=whales.filter(w=>w.tracked);
  document.getElementById('whale-cards').innerHTML=`
    <div class="card"><div class="card-l">Whales Tracked</div><div class="card-v">${tracked.length}</div></div>
    <div class="card"><div class="card-l">Paper Trades</div><div class="card-v">${s.paper_trades||0}</div></div>
    <div class="card"><div class="card-l">Total Copy P&L</div><div class="card-v ${pc(s.total_copy_pnl)}">${f$(s.total_copy_pnl)}</div></div>
    <div class="card"><div class="card-l">Best Whale</div><div class="card-v" style="font-size:0.9rem">${s.best_whale||'‚Äî'}</div></div>`;
  const st=[...tracked].sort((a,b)=>(b.our_pnl||0)-(a.our_pnl||0));
  document.querySelector('#whale-lb tbody').innerHTML=st.map(w=>{
    const hc=w.copies>0;
    return`<tr class="${hc?'tracked-row':''}">
      <td style="color:var(--blue);font-weight:600">${w.name||w.address?.slice(0,8)||'‚Äî'}</td>
      <td>#${w.rank}</td><td style="color:var(--green)">${w.weekly_pnl||'‚Äî'}</td><td>${w.volume||'‚Äî'}</td>
      <td>${w.copies||0}</td><td class="${pc(w.our_pnl)}">${f$(w.our_pnl)}</td>
      <td>${hc?fP(w.win_rate*100):'‚Äî'}</td>
      <td>${hc?'<span class="badge b-a">Active</span>':'<span class="badge b-s">Watching</span>'}</td></tr>`}).join('');
  document.querySelector('#whale-trades tbody').innerHTML=(d.recent_trades||[]).slice(0,20).map(t=>{
    const ts=t.timestamp?new Date(t.timestamp).toLocaleString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}):'‚Äî';
    const sc=t.status==='WIN'?'g':t.status==='LOSS'?'r':'';
    return`<tr><td>${ts}</td><td style="max-width:180px;overflow:hidden;text-overflow:ellipsis">${t.market_title||'‚Äî'}</td>
      <td>${t.side||'‚Äî'}</td><td>${f2(t.whale_price,2)}¬¢</td><td>${f2(t.our_price,2)}¬¢</td>
      <td>${f$(t.our_size_usd)}</td><td class="${sc}">${t.status||'PENDING'}</td>
      <td class="${pc(t.pnl)}">${t.pnl!=null?f$(t.pnl):'‚Äî'}</td></tr>`}).join('');
  const untracked=whales.filter(w=>!w.tracked).sort((a,b)=>a.rank-b.rank);
  document.querySelector('#whale-all tbody').innerHTML=untracked.map(w=>`<tr>
    <td>#${w.rank}</td><td>${w.name||w.address?.slice(0,8)||'‚Äî'}</td>
    <td style="color:var(--green)">${w.weekly_pnl||'‚Äî'}</td><td>${w.volume||'‚Äî'}</td>
    <td><span class="badge b-s">No</span></td></tr>`).join('');
}

refresh();setInterval(refresh,60000);loadWhale();setInterval(loadWhale,60000);
</script>
</body>
</html>
